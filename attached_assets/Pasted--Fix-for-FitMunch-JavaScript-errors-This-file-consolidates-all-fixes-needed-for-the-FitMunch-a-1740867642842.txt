// Fix for FitMunch JavaScript errors
// This file consolidates all fixes needed for the FitMunch app

// Global variables
const userProfile = JSON.parse(localStorage.getItem('userProfile')) || {
  name: 'Guest User',
  height: '175',
  weight: '70',
  goals: {
    calories: 2000,
    steps: 10000,
    activityPlan: {
      type: 'gym',
      frequency: 3,
      level: 'Beginner',
      duration: 1,
      preferredTime: 'Morning (6-9)'
    },
    description: 'Maintain weight and improve fitness'
  }
};

const dailyLog = {
  meals: {
    breakfast: [],
    lunch: [],
    dinner: [],
    snacks: []
  },
  totalCalories: 0,
  totalSteps: 0
};

// Navigation function
function showSection(sectionId) {
  const sections = document.querySelectorAll('section, #dashboard');
  sections.forEach(section => {
    section.style.display = 'none';
    section.classList.remove('active-section');
  });
  
  const selectedSection = document.getElementById(sectionId);
  if (selectedSection) {
    selectedSection.style.display = 'block';
    selectedSection.classList.add('active-section');
  }
  
  const navItems = document.querySelectorAll('.nav-item');
  navItems.forEach(item => {
    item.classList.toggle('active', item.getAttribute('data-section') === sectionId);
  });
}

// Update profile display
function updateProfileDisplay() {
  const userName = document.getElementById('userName');
  const currentDate = document.getElementById('currentDate');
  const calorieDisplay = document.getElementById('calorieDisplay');
  const stepsDisplay = document.getElementById('stepsDisplay');
  
  if (userName) userName.textContent = userProfile.name;
  if (currentDate) currentDate.textContent = new Date().toLocaleDateString('en-AU', { weekday: 'long', day: 'numeric', month: 'long' });
  
  const profileStats = document.querySelector('.profile-stats');
  if (profileStats) {
    profileStats.innerHTML = `
      <div class="stat-item">
        <span class="stat-value">${userProfile.height}cm</span>
        <span class="stat-label">Height</span>
      </div>
      <div class="stat-item">
        <span class="stat-value">${userProfile.weight}kg</span>
        <span class="stat-label">Weight</span>
      </div>
    `;
  }
  
  if (calorieDisplay) calorieDisplay.textContent = userProfile.goals.calories;
  if (stepsDisplay) stepsDisplay.textContent = userProfile.goals.steps;
  
  updateProgressBars();
}

// Calculate macros (simplified for demo)
function calculateMacros(goalType) {
  switch (goalType) {
    case 'Weight Loss':
      return { protein: 100, carbs: 150, fat: 50 };
    case 'Maintenance':
      return { protein: 120, carbs: 200, fat: 70 };
    case 'Muscle Gain':
      return { protein: 150, carbs: 250, fat: 80 };
    default:
      return { protein: 120, carbs: 200, fat: 70 };
  }
}

// Generate meal plan (fixed syntax error)
function generateMealPlan() {
  console.log("Generating meal plan");
  const mealSection = document.getElementById('meal');
  if (!mealSection || !mealSection.classList.contains('active-section')) return;
  
  const goalType = document.getElementById('goalType')?.value || "Maintenance";
  
  // Correctly defined mealPlans object
  const mealPlans = {
    "Weight Loss": {
      breakfast: ["Egg white omelet with spinach", "Greek yogurt with berries", "Protein smoothie"],
      lunch: ["Grilled chicken salad", "Tuna salad with crackers", "Veggie wrap with hummus"],
      dinner: ["Baked salmon with asparagus", "Turkey breast with steamed vegetables", "Tofu stir-fry"],
      snacks: ["Apple with almond butter", "Greek yogurt", "Protein bar"]
    },
    "Maintenance": {
      breakfast: ["Oatmeal with fruits and nuts", "Whole grain toast with avocado", "Smoothie bowl"],
      lunch: ["Turkey sandwich on whole grain", "Quinoa bowl with vegetables", "Lentil soup with bread"],
      dinner: ["Grilled fish with brown rice", "Chicken stir-fry with vegetables", "Pasta with lean meat sauce"],
      snacks: ["Handful of mixed nuts", "Fruit with yogurt", "Hummus with vegetables"]
    },
    "Muscle Gain": {
      breakfast: ["Protein pancakes with banana", "Scrambled eggs with toast", "Oatmeal with protein powder"],
      lunch: ["Chicken breast with sweet potato", "Beef stir-fry with rice", "Salmon with quinoa"],
      dinner: ["Steak with vegetables", "Pasta with meat sauce", "Grilled chicken with rice"],
      snacks: ["Protein shake", "Cottage cheese with fruit", "Nuts and seeds"]
    }
  };
  
  // Select random meals
  const selectedMeals = {
    breakfast: mealPlans[goalType].breakfast[Math.floor(Math.random() * mealPlans[goalType].breakfast.length)],
    lunch: mealPlans[goalType].lunch[Math.floor(Math.random() * mealPlans[goalType].lunch.length)],
    dinner: mealPlans[goalType].dinner[Math.floor(Math.random() * mealPlans[goalType].dinner.length)],
    snack: mealPlans[goalType].snacks[Math.floor(Math.random() * mealPlans[goalType].snacks.length)]
  };
  
  // Display meals
  const mealPlanDisplay = document.getElementById('mealPlanDisplay');
  if (mealPlanDisplay) {
    mealPlanDisplay.innerHTML = `
      <h3>Your Daily Meal Plan</h3>
      <ul>
        <li><strong>Breakfast:</strong> ${selectedMeals.breakfast}</li>
        <li><strong>Lunch:</strong> ${selectedMeals.lunch}</li>
        <li><strong>Dinner:</strong> ${selectedMeals.dinner}</li>
        <li><strong>Snack:</strong> ${selectedMeals.snack}</li>
      </ul>
    `;
  }
  
  // Calculate and display macros
  const macros = calculateMacros(goalType);
  const mealProtein = document.getElementById('mealProtein');
  const mealCarbs = document.getElementById('mealCarbs');
  const mealFat = document.getElementById('mealFat');
  
  if (mealProtein) mealProtein.textContent = macros.protein + 'g';
  if (mealCarbs) mealCarbs.textContent = macros.carbs + 'g';
  if (mealFat) mealFat.textContent = macros.fat + 'g';
  
  // Calculate and display cost estimates
  const dailyCost = 15.00 + (Math.random() * 10);
  const weeklyCost = dailyCost * 7;
  
  const dailyCostElement = document.getElementById('dailyCost');
  const weeklyCostElement = document.getElementById('weeklyCost');
  
  if (dailyCostElement) dailyCostElement.textContent = '$' + dailyCost.toFixed(2);
  if (weeklyCostElement) weeklyCostElement.textContent = '$' + weeklyCost.toFixed(2);
}

// Update shopping list
function updateShoppingList(mealPlan) {
  const shoppingSection = document.getElementById('shopping');
  if (!shoppingSection) return;
  
  const shoppingItems = generateShoppingItems(mealPlan);
  
  const shopList = document.getElementById('shopList');
  if (shopList) {
    let listHTML = '';
    const categories = {
      'Proteins': [],
      'Fruits & Vegetables': [],
      'Grains & Pasta': [],
      'Dairy & Eggs': [],
      'Nuts & Seeds': [],
      'Other': []
    };
    
    shoppingItems.forEach(item => {
      (categories[item.category] || categories['Other']).push(item);
    });
    
    for (const [category, items] of Object.entries(categories)) {
      if (items.length > 0) {
        listHTML += `<h3 class="shop-category">${category}</h3><ul class="shopping-items">`;
        items.forEach(item => {
          listHTML += `
            <li class="shop-item">
              <div class="item-details">
                <span class="item-name">${item.name}</span>
                <span class="item-quantity">${item.quantity}</span>
              </div>
              <div class="item-price">$${item.price.toFixed(2)}</div>
            </li>
          `;
        });
        listHTML += '</ul>';
      }
    }
    
    shopList.innerHTML = listHTML;
  }
  
  const totalCost = shoppingItems.reduce((sum, item) => sum + item.price, 0);
  const totalItems = shoppingItems.length;
  
  const totalCostElement = document.getElementById('totalCost');
  const totalItemsElement = document.getElementById('totalItems');
  
  if (totalCostElement) totalCostElement.textContent = '$' + totalCost.toFixed(2);
  if (totalItemsElement) totalItemsElement.textContent = totalItems;
}

// Generate shopping items
function generateShoppingItems(mealPlan) {
  return [
    { name: "Chicken Breast", quantity: "1kg", price: 12.50, category: "Proteins" },
    { name: "Eggs", quantity: "1 dozen", price: 6.50, category: "Dairy & Eggs" },
    { name: "Greek Yogurt", quantity: "750g", price: 5.50, category: "Dairy & Eggs" },
    { name: "Salmon", quantity: "500g", price: 15.00, category: "Proteins" },
    { name: "Brown Rice", quantity: "1kg", price: 4.50, category: "Grains & Pasta" },
    { name: "Sweet Potato", quantity: "1kg", price: 4.00, category: "Fruits & Vegetables" },
    { name: "Broccoli", quantity: "500g", price: 3.50, category: "Fruits & Vegetables" },
    { name: "Spinach", quantity: "250g", price: 3.00, category: "Fruits & Vegetables" },
    { name: "Bananas", quantity: "1kg", price: 4.90, category: "Fruits & Vegetables" },
    { name: "Berries", quantity: "250g", price: 6.00, category: "Fruits & Vegetables" },
    { name: "Almonds", quantity: "250g", price: 6.50, category: "Nuts & Seeds" },
    { name: "Oats", quantity: "750g", price: 5.00, category: "Grains & Pasta" },
    { name: "Whole Grain Bread", quantity: "1 loaf", price: 4.20, category: "Grains & Pasta" },
    { name: "Olive Oil", quantity: "500ml", price: 8.00, category: "Other" },
    { name: "Protein Powder", quantity: "500g", price: 29.99, category: "Other" }
  ];
}

// Generate activity plan
function generateActivityPlan() {
  const workoutSection = document.getElementById('workout');
  if (!workoutSection || !workoutSection.classList.contains('active-section')) return;
  
  const activityPlan = userProfile.goals.activityPlan;
  const activityType = activityPlan.type || 'gym';
  const frequency = activityPlan.frequency || 3;
  const level = activityPlan.level || 'Beginner';
  const duration = activityPlan.duration || 1;
  const preferredTime = activityPlan.preferredTime || 'Morning (6-9)';
  
  let workouts = [];
  if (activityType === 'gym') {
    if (level === 'Beginner') {
      workouts = [
        { day: 'Monday', workout: 'Full Body Workout', description: 'Basic strength training', duration: duration },
        { day: 'Wednesday', workout: 'Cardio', description: '30 minutes moderate intensity', duration: duration },
        { day: 'Friday', workout: 'Full Body Workout', description: 'Different exercises', duration: duration }
      ];
    } else if (level === 'Intermediate') {
      workouts = [
        { day: 'Monday', workout: 'Upper Body', description: 'Chest, back, shoulders, arms', duration: duration },
        { day: 'Tuesday', workout: 'Lower Body', description: 'Legs, glutes, core', duration: duration },
        { day: 'Thursday', workout: 'HIIT Cardio', description: 'High-intensity intervals', duration: duration },
        { day: 'Friday', workout: 'Full Body', description: 'Compound movements', duration: duration }
      ];
    } else {
      workouts = [
        { day: 'Monday', workout: 'Push Day', description: 'Chest, shoulders, triceps', duration: duration },
        { day: 'Tuesday', workout: 'Pull Day', description: 'Back and biceps', duration: duration },
        { day: 'Wednesday', workout: 'Legs Day', description: 'Quads, hamstrings, glutes', duration: duration },
        { day: 'Thursday', workout: 'HIIT Cardio', description: 'High-intensity intervals', duration: duration },
        { day: 'Friday', workout: 'Upper Body', description: 'Focus on weaker groups', duration: duration },
        { day: 'Saturday', workout: 'Active Recovery', description: 'Light cardio', duration: 0.5 }
      ];
    }
  } else {
    workouts = [
      { day: 'Monday', workout: 'Workout 1', description: 'Activity based on preferences', duration: duration },
      { day: 'Wednesday', workout: 'Workout 2', description: 'Activity based on preferences', duration: duration },
      { day: 'Friday', workout: 'Workout 3', description: 'Activity based on preferences', duration: duration }
    ];
  }
  
  const workoutPlanDisplay = document.getElementById('workoutPlanDisplay');
  if (workoutPlanDisplay) {
    let planHTML = `
      <div class="plan-header">
        <h3>Weekly Activity Plan</h3>
        <p>Type: ${capitalizeFirstLetter(activityType)} | Level: ${level} | Frequency: ${frequency} days/week</p>
      </div>
      <div class="workouts-container">
    `;
    workouts.forEach(workout => {
      planHTML += `
        <div class="workout-card">
          <div class="workout-day">${workout.day}</div>
          <div class="workout-title">${workout.workout}</div>
          <div class="workout-time">${workout.duration} hour${workout.duration !== 1 ? 's' : ''}</div>
          <div class="workout-desc">${workout.description}</div>
        </div>
      `;
    });
    planHTML += '</div>';
    workoutPlanDisplay.innerHTML = planHTML;
  }
  
  generateWeeklySchedule(workouts, preferredTime);
}

// Helper functions
function capitalizeFirstLetter(string) {
  return string.charAt(0).toUpperCase() + string.slice(1);
}

function generateWeeklySchedule(workouts, preferredTime) {
  const weeklyScheduleDisplay = document.getElementById('weeklyScheduleDisplay');
  if (weeklyScheduleDisplay) {
    let scheduleHTML = `
      <div class="schedule-header">
        <h3>Weekly Schedule</h3>
        <p>Preferred Time: ${preferredTime}</p>
      </div>
      <div class="schedule-grid">
        <div class="schedule-day">Monday</div>
        <div class="schedule-day">Tuesday</div>
        <div class="schedule-day">Wednesday</div>
        <div class="schedule-day">Thursday</div>
        <div class="schedule-day">Friday</div>
        <div class="schedule-day">Saturday</div>
        <div class="schedule-day">Sunday</div>
    `;
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    days.forEach(day => {
      const workout = workouts.find(w => w.day === day);
      scheduleHTML += workout
        ? `<div class="schedule-cell workout"><div class="schedule-workout">${workout.workout}</div><div class="schedule-time">${preferredTime}</div></div>`
        : `<div class="schedule-cell rest">Rest Day</div>`;
    });
    scheduleHTML += '</div>';
    weeklyScheduleDisplay.innerHTML = scheduleHTML;
  }
}

function updateProgressBars() {
  const calorieProgress = document.getElementById('calorieProgress');
  const stepsProgress = document.getElementById('stepsProgress');
  const activityProgress = document.getElementById('activityProgress');
  
  if (calorieProgress) {
    const caloriePercent = Math.min(100, Math.round((dailyLog.totalCalories / userProfile.goals.calories) * 100));
    calorieProgress.style.width = `${caloriePercent}%`;
  }
  
  if (stepsProgress) {
    const stepsPercent = Math.min(100, Math.round((dailyLog.totalSteps / userProfile.goals.steps) * 100));
    stepsProgress.style.width = `${stepsPercent}%`;
  }
  
  if (activityProgress) {
    const activityPercent = 65; // Example value
    activityProgress.style.width = `${activityPercent}%`;
  }
}

// GrokAgent class
class GrokAgent {
  constructor() {
    this.initialized = false;
    this.userPreferences = null;
    this.functionRegistry = {};
  }
  
  initialize(userProfile) {
    this.userPreferences = userProfile || {};
    this.initialized = true;
    
    // Debug logging to verify function availability
    console.log("Checking function availability:");
    console.log("window.showSection:", typeof window.showSection);
    console.log("window.updateProfileDisplay:", typeof window.updateProfileDisplay);
    console.log("window.generateMealPlan:", typeof window.generateMealPlan);
    console.log("window.calculateMacros:", typeof window.calculateMacros);
    console.log("window.updateShoppingList:", typeof window.updateShoppingList);
    console.log("window.generateActivityPlan:", typeof window.generateActivityPlan);
    
    // Register functions
    this.registerFunction('showSection', window.showSection);
    this.registerFunction('updateProfileDisplay', window.updateProfileDisplay);
    this.registerFunction('generateMealPlan', window.generateMealPlan);
    this.registerFunction('calculateMacros', window.calculateMacros);
    this.registerFunction('updateShoppingList', window.updateShoppingList);
    this.registerFunction('generateActivityPlan', window.generateActivityPlan);
    
    console.log("Grok Agent initialized with registered functions:", this.getRegisteredFunctions());
    return true;
  }
  
  registerFunction(name, func) {
    if (typeof func === 'function') {
      this.functionRegistry[name] = func;
      return true;
    }
    console.warn(`Failed to register ${name}: not a function`);
    return false;
  }
  
  executeFunction(name, ...args) {
    if (name in this.functionRegistry) {
      return this.functionRegistry[name](...args);
    }
    console.error(`Function ${name} not found in registry`);
    return null;
  }
  
  getRegisteredFunctions() {
    return Object.keys(this.functionRegistry);
  }
  
  isInitialized() {
    return this.initialized;
  }
}

// Expose to window object
window.grokAgent = new GrokAgent();
window.showSection = showSection;
window.updateProfileDisplay = updateProfileDisplay;
window.generateMealPlan = generateMealPlan;
window.calculateMacros = calculateMacros;
window.updateShoppingList = updateShoppingList;
window.generateActivityPlan = generateActivityPlan;

// Initialization on page load
document.addEventListener('DOMContentLoaded', function() {
  console.log("Initializing app...");
  
  try {
    updateProfileDisplay();
  } catch (error) {
    console.error("Error updating profile:", error);
  }
  
  document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', function() {
      const section = this.getAttribute('data-section');
      showSection(section);
    });
  });
  
  if (window.grokAgent) {
    window.grokAgent.initialize({
      name: 'Test User',
      height: '175',
      weight: '70',
      goals: { calories: 2000, steps: 10000 }
    });
  }
  
  showSection('dashboard');
});

// Test function
function testAllFunctions() {
  console.log("Testing all functions...");
  const results = {
    showSection: typeof window.showSection === 'function',
    updateProfileDisplay: typeof window.updateProfileDisplay === 'function',
    generateMealPlan: typeof window.generateMealPlan === 'function',
    calculateMacros: typeof window.calculateMacros === 'function',
    updateShoppingList: typeof window.updateShoppingList === 'function',
    generateActivityPlan: typeof window.generateActivityPlan === 'function',
    grokAgentInitialized: window.grokAgent && window.grokAgent.isInitialized()
  };
  
  console.log("Function test results:", results);
  const allPassed = Object.values(results).every(result => result === true);
  console.log(`All functions ${allPassed ? 'PASSED' : 'FAILED'}`);
  return results;
}

window.testAllFunctions = testAllFunctions;