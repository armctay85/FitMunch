<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>FitMunch</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --green:#22c55e;--green2:#16a34a;--green3:#15803d;
  --bg:#f8fafc;--bg2:#f1f5f9;--dark:#0f172a;
  --text:#0f172a;--text2:#475569;--text3:#94a3b8;
  --border:#e2e8f0;--border2:#cbd5e1;
  --surface:#ffffff;--radius:10px;
  --purple:#7c3aed;--amber:#f59e0b;--red:#ef4444;--blue:#3b82f6;
}
html,body{height:100%;overflow:hidden}
body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);font-size:13px;-webkit-font-smoothing:antialiased;display:flex;flex-direction:column}

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
.topnav{
  height:52px;background:#fff;border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 20px;gap:12px;flex-shrink:0;
}
.nav-logo{display:flex;align-items:center;gap:8px;text-decoration:none;margin-right:8px}
.logo-m{width:28px;height:28px;border-radius:8px;overflow:hidden;display:flex;align-items:center;justify-content:center}
.logo-m svg{width:28px;height:28px;display:block}
.logo-w{font-size:1rem;font-weight:900;color:var(--text);letter-spacing:-.03em}
.logo-w span{color:var(--green2)}
.nav-spacer{flex:1}
.nav-plan{font-size:.72rem;font-weight:700;padding:3px 10px;border-radius:4px;background:#f0fdf4;color:var(--green2);border:1px solid #bbf7d0;margin-right:4px}
.nav-user{font-size:.82rem;font-weight:600;color:var(--text2);display:flex;align-items:center;gap:6px}
.nav-av{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--purple),#a78bfa);display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:700;color:#fff;flex-shrink:0}
.nav-btn{padding:5px 12px;border-radius:6px;font-size:.78rem;font-weight:600;cursor:pointer;border:none;transition:all .15s}
.btn-logout{background:transparent;color:var(--text3)}
.btn-logout:hover{color:var(--red)}
.btn-upgrade{background:var(--green2);color:#fff}
.btn-upgrade:hover{background:var(--green3)}

/* ‚îÄ‚îÄ SHELL ‚îÄ‚îÄ */
.shell{display:flex;flex:1;overflow:hidden}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar{
  width:200px;flex-shrink:0;background:#fff;border-right:1px solid var(--border);
  display:flex;flex-direction:column;padding:12px 8px;overflow-y:auto;
}
.sb-section-label{font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);padding:8px 8px 4px;margin-top:4px}
.sb-item{
  display:flex;align-items:center;gap:9px;padding:7px 10px;
  border-radius:7px;cursor:pointer;font-size:.8rem;font-weight:500;
  color:var(--text2);transition:all .15s;border:none;background:none;width:100%;text-align:left;
}
.sb-item:hover{background:var(--bg2);color:var(--text)}
.sb-item.active{background:#f0fdf4;color:var(--green2);font-weight:700}
.sb-icon{font-size:13px;width:16px;text-align:center;flex-shrink:0}
.sb-badge{margin-left:auto;background:var(--bg2);color:var(--text3);font-size:.6rem;font-weight:700;padding:1px 5px;border-radius:3px;min-width:16px;text-align:center}
.sb-badge.alert{background:rgba(239,68,68,.12);color:var(--red)}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main{flex:1;overflow:hidden;display:flex;flex-direction:column}
.view{display:none;flex:1;flex-direction:column;overflow:hidden}
.view.active{display:flex}
.view-header{padding:16px 20px 0;flex-shrink:0;display:flex;align-items:flex-end;justify-content:space-between;gap:10px}
.view-title{font-size:1.1rem;font-weight:800;letter-spacing:-.03em}
.view-sub{font-size:.75rem;color:var(--text3);margin-top:2px}
.view-actions{display:flex;gap:8px;align-items:center}
.scroll-body{flex:1;overflow-y:auto;padding:14px 20px 24px}
.scroll-body::-webkit-scrollbar{width:4px}
.scroll-body::-webkit-scrollbar-thumb{background:var(--border2);border-radius:4px}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{display:inline-flex;align-items:center;gap:5px;padding:6px 14px;border-radius:7px;font-size:.78rem;font-weight:700;cursor:pointer;border:none;transition:all .15s}
.btn-green{background:var(--green2);color:#fff}.btn-green:hover{background:var(--green3)}
.btn-ghost2{background:var(--bg2);color:var(--text2);border:1px solid var(--border)}.btn-ghost2:hover{color:var(--text)}
.btn-red{background:rgba(239,68,68,.08);color:var(--red);border:1px solid rgba(239,68,68,.2)}.btn-red:hover{background:rgba(239,68,68,.15)}
.btn-sm{padding:4px 10px;font-size:.72rem}

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.card-header{padding:10px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:8px}
.card-title{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3)}
.card-body{padding:14px}

/* ‚îÄ‚îÄ METRICS ‚îÄ‚îÄ */
.metrics-row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px}
.metric{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:12px 14px}
.metric-label{font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--text3);margin-bottom:6px}
.metric-value{font-size:1.6rem;font-weight:900;letter-spacing:-.04em;line-height:1}
.metric-sub{font-size:.72rem;color:var(--text3);margin-top:4px}
.mv-green{color:var(--green2)}.mv-purple{color:var(--purple)}.mv-amber{color:var(--amber)}.mv-blue{color:var(--blue)}

/* ‚îÄ‚îÄ CLIENT LIST ‚îÄ‚îÄ */
.client-row{
  display:flex;align-items:center;gap:12px;padding:12px 14px;
  border-bottom:1px solid var(--border);cursor:pointer;transition:background .1s;
}
.client-row:last-child{border:none}
.client-row:hover{background:var(--bg)}
.c-av{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.72rem;font-weight:700;color:#fff;flex-shrink:0}
.c-name{font-size:.85rem;font-weight:700;color:var(--text);margin-bottom:2px}
.c-meta{font-size:.72rem;color:var(--text3)}
.c-stats{display:flex;gap:14px;margin-left:auto;align-items:center}
.c-stat{text-align:center}
.c-stat-v{font-size:.85rem;font-weight:700;color:var(--text);line-height:1}
.c-stat-l{font-size:.6rem;color:var(--text3)}
.compliance-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.comp-high{background:var(--green)}.comp-mid{background:var(--amber)}.comp-low{background:var(--red)}
.phase-chip{font-size:.62rem;font-weight:700;padding:2px 7px;border-radius:3px;text-transform:uppercase;letter-spacing:.4px}
.phase-deficit{background:#fef3c7;color:#92400e}
.phase-bulk{background:#eff6ff;color:#1e40af}
.phase-maintain{background:#f0fdf4;color:var(--green2)}

/* ‚îÄ‚îÄ PLAN CARDS ‚îÄ‚îÄ */
.plan-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.plan-card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:14px;cursor:pointer;transition:all .15s}
.plan-card:hover{border-color:var(--green2);box-shadow:0 4px 14px rgba(22,163,74,.08)}
.plan-card-name{font-size:.85rem;font-weight:700;color:var(--text);margin-bottom:4px}
.plan-card-meta{font-size:.72rem;color:var(--text3)}
.plan-card-footer{display:flex;align-items:center;gap:8px;margin-top:10px;padding-top:10px;border-top:1px solid var(--border)}

/* ‚îÄ‚îÄ SHOPPING LIST ‚îÄ‚îÄ */
.shop-category{margin-bottom:16px}
.shop-cat-label{font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--text3);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.shop-cat-icon{font-size:12px}
.shop-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:7px;border:1px solid var(--border);background:#fff;margin-bottom:6px;transition:all .15s}
.shop-item.checked{opacity:.5;background:var(--bg2)}
.shop-cb{width:16px;height:16px;border-radius:4px;border:1.5px solid var(--border2);cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:.65rem;transition:all .15s}
.shop-cb.checked{background:var(--green2);border-color:var(--green2);color:#fff}
.shop-name{flex:1;font-size:.82rem;font-weight:500;color:var(--text)}
.shop-qty{font-size:.75rem;color:var(--text3)}

/* ‚îÄ‚îÄ FAVOURITES ‚îÄ‚îÄ */
.fav-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.fav-card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:12px;position:relative;transition:all .15s}
.fav-card:hover{border-color:var(--border2)}
.fav-heart{position:absolute;top:8px;right:8px;cursor:pointer;font-size:14px;color:var(--red)}
.fav-type{font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:4px}
.fav-name{font-size:.82rem;font-weight:600;color:var(--text)}

/* ‚îÄ‚îÄ PROGRESS LOGS ‚îÄ‚îÄ */
.progress-form{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px}
.form-field{display:flex;flex-direction:column;gap:4px}
.form-label{font-size:.68rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--text3)}
.form-input{background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:7px 10px;font-size:.82rem;color:var(--text);outline:none;transition:border-color .15s;font-family:inherit}
.form-input:focus{border-color:var(--green2)}
.form-select{background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:7px 10px;font-size:.82rem;color:var(--text);outline:none;font-family:inherit}

/* ‚îÄ‚îÄ MEAL LOG ‚îÄ‚îÄ */
.meal-section{margin-bottom:16px}
.meal-section-title{font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.food-item{display:flex;align-items:center;gap:10px;padding:8px 10px;background:#fff;border:1px solid var(--border);border-radius:7px;margin-bottom:6px}
.food-name{flex:1;font-size:.82rem;font-weight:500}
.food-cals{font-size:.78rem;font-weight:700;color:var(--text)}
.food-macro{font-size:.68rem;color:var(--text3)}
.fav-btn{background:none;border:none;cursor:pointer;font-size:14px;padding:2px;opacity:.5;transition:opacity .15s}
.fav-btn:hover,.fav-btn.active{opacity:1}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:200;opacity:0;pointer-events:none;transition:opacity .2s;backdrop-filter:blur(4px)}
.modal-overlay.open{opacity:1;pointer-events:all}
.modal{background:#fff;border-radius:12px;padding:22px;width:460px;max-width:90vw;transform:scale(.96) translateY(8px);transition:transform .2s;border:1px solid var(--border)}
.modal-overlay.open .modal{transform:scale(1) translateY(0)}
.modal-title{font-size:.95rem;font-weight:800;letter-spacing:-.02em;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between}
.modal-close{background:none;border:none;font-size:1.1rem;cursor:pointer;color:var(--text3);padding:2px 6px}
.modal-close:hover{color:var(--text)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:16px}

/* ‚îÄ‚îÄ INVITE BANNER ‚îÄ‚îÄ */
.invite-banner{
  background:linear-gradient(135deg,#f0fdf4,#dcfce7);
  border:1px solid #bbf7d0;border-radius:var(--radius);
  padding:14px 18px;display:flex;align-items:center;gap:12px;margin-bottom:16px;
}
.invite-link{font-size:.75rem;font-family:monospace;background:#fff;border:1px solid var(--border);border-radius:5px;padding:5px 10px;flex:1;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.copy-btn{font-size:.75rem;font-weight:700;padding:5px 12px;background:var(--green2);color:#fff;border:none;border-radius:6px;cursor:pointer;white-space:nowrap}
.copy-btn:active{transform:scale(.97)}

/* ‚îÄ‚îÄ CLIENT DETAIL PANEL ‚îÄ‚îÄ */
.detail-panel{display:flex;flex-direction:column;height:100%;overflow:hidden}
.detail-header{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;flex-shrink:0;background:#fff}
.back-btn{background:none;border:none;cursor:pointer;font-size:.82rem;color:var(--text3);padding:4px 8px;border-radius:5px;display:flex;align-items:center;gap:4px}
.back-btn:hover{color:var(--text);background:var(--bg2)}
.detail-tabs{display:flex;gap:2px;padding:0 20px;border-bottom:1px solid var(--border);background:#fff;flex-shrink:0}
.detail-tab{padding:10px 14px;font-size:.78rem;font-weight:600;cursor:pointer;color:var(--text3);border-bottom:2px solid transparent;transition:all .15s}
.detail-tab.active{color:var(--green2);border-bottom-color:var(--green2)}
.detail-body{flex:1;overflow-y:auto;padding:16px 20px}

/* ‚îÄ‚îÄ PORTAL (CLIENT VIEW) ‚îÄ‚îÄ */
.portal-plan{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:14px}
.portal-plan-title{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:8px}
.portal-plan-name{font-size:.95rem;font-weight:800;color:var(--text);margin-bottom:4px}
.portal-plan-meta{font-size:.75rem;color:var(--text2)}

/* ‚îÄ‚îÄ WORKOUT LOG ‚îÄ‚îÄ */
.workout-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:#fff;border:1px solid var(--border);border-radius:7px;margin-bottom:6px}
.exercise-name{flex:1;font-size:.82rem;font-weight:600}
.exercise-detail{font-size:.72rem;color:var(--text3)}

/* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
.tag{display:inline-block;font-size:.62rem;font-weight:700;padding:2px 7px;border-radius:3px;text-transform:uppercase;letter-spacing:.4px}
.tag-green{background:#f0fdf4;color:var(--green2);border:1px solid #bbf7d0}
.tag-amber{background:#fef3c7;color:#92400e}
.tag-red{background:#fef2f2;color:#991b1b}
.tag-blue{background:#eff6ff;color:#1e40af}
.tag-purple{background:rgba(124,58,237,.08);color:var(--purple)}
.divider{height:1px;background:var(--border);margin:14px 0}
.empty-state{text-align:center;padding:40px 20px;color:var(--text3)}
.empty-state .ei{font-size:28px;margin-bottom:8px}
.empty-state .et{font-size:.82rem;font-weight:600;color:var(--text2);margin-bottom:4px}
.empty-state .es{font-size:.75rem}
.loader{display:inline-block;width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--green2);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
/* Feature tiles */
.feat-tile{background:#fff;border:1px solid var(--border);border-radius:10px;padding:16px 14px;cursor:pointer;transition:all .15s;text-align:center}
.feat-tile:hover{border-color:var(--green2);box-shadow:0 4px 14px rgba(22,163,74,.1);transform:translateY(-1px)}
.ft-icon{font-size:22px;margin-bottom:6px}
.ft-label{font-size:.82rem;font-weight:700;color:var(--text);margin-bottom:2px}
.ft-sub{font-size:.68rem;color:var(--text3)}

/* ‚îÄ‚îÄ MOBILE BOTTOM NAV ‚îÄ‚îÄ */
.mobile-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid var(--border);z-index:100;padding:0 4px env(safe-area-inset-bottom,0)}
.mob-nav-items{display:flex;justify-content:space-around;align-items:stretch}
.mob-nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px 2px 10px;border:none;background:none;cursor:pointer;color:var(--text3);font-size:.58rem;font-weight:600;gap:3px;min-height:56px;-webkit-tap-highlight-color:transparent;border-radius:0}
.mob-nav-btn .mn-icon{font-size:20px;line-height:1}
.mob-nav-btn.active{color:var(--green2)}
.mob-nav-more{position:fixed;bottom:56px;left:0;right:0;background:#fff;border-top:1px solid var(--border);padding:10px 16px 12px;z-index:99;display:none;flex-wrap:wrap;gap:8px}
.mob-nav-more.open{display:flex}
.mob-more-btn{display:flex;align-items:center;gap:8px;padding:10px 14px;border-radius:8px;border:1px solid var(--border);background:#fff;cursor:pointer;font-size:.8rem;font-weight:600;color:var(--text);flex:1;min-width:140px;-webkit-tap-highlight-color:transparent}

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media (max-width: 767px) {
  .sidebar{display:none !important}
  .mobile-nav{display:block}
  .shell{padding-bottom:56px}
  .scroll-body{padding:12px 14px 20px}
  .view-header{padding:12px 14px 0;flex-direction:column;align-items:flex-start;gap:8px}
  /* 2-col feat tiles on mobile */
  #view-dashboard .feat-tile-grid{grid-template-columns:repeat(2,1fr) !important}
  /* Metrics: 2-col */
  .metrics-row{grid-template-columns:repeat(2,1fr) !important}
  /* Client detail back button visibility */
  .topnav{padding:0 12px}
}
</style>
</head>
<body>

<!-- TOP NAV -->
<nav class="topnav">
  <a href="/" class="nav-logo">
    <div class="logo-m"><svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="alb" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#14532d"/><stop offset="100%" stop-color="#052e16"/></linearGradient><linearGradient id="albr" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#4ade80"/><stop offset="100%" stop-color="#22c55e"/></linearGradient><linearGradient id="ala" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#4ade80"/><stop offset="100%" stop-color="#16a34a"/></linearGradient></defs><rect width="512" height="512" fill="url(#alb)"/><circle cx="256" cy="128" r="82" fill="url(#albr)"/><circle cx="175" cy="168" r="68" fill="url(#albr)"/><circle cx="337" cy="168" r="68" fill="url(#albr)"/><ellipse cx="256" cy="200" rx="110" ry="52" fill="url(#albr)"/><rect x="228" y="228" width="56" height="108" rx="12" fill="white"/><rect x="142" y="348" width="228" height="26" rx="13" fill="white"/><rect x="166" y="334" width="34" height="54" rx="9" fill="url(#ala)"/><rect x="312" y="334" width="34" height="54" rx="9" fill="url(#ala)"/><rect x="118" y="316" width="62" height="90" rx="16" fill="white"/><rect x="134" y="334" width="26" height="54" rx="8" fill="url(#alb)"/><rect x="332" y="316" width="62" height="90" rx="16" fill="white"/><rect x="352" y="334" width="26" height="54" rx="8" fill="url(#alb)"/></svg></div>
    <span class="logo-w">Fit<span>Munch</span></span>
  </a>
  <div class="nav-spacer"></div>
  <span class="nav-plan" id="nav-plan-badge" style="display:none"></span>
  <div class="nav-user"><div class="nav-av" id="nav-av"></div><span id="nav-name"></span></div>
  <button class="nav-btn btn-upgrade" id="btn-upgrade" onclick="nav('billing')" style="display:none">Upgrade</button>
  <button class="nav-btn btn-logout" onclick="logout()">Sign out</button>
</nav>

<div class="shell">
<!-- SIDEBAR ‚Äî PT VIEW -->
<nav class="sidebar" id="sidebar-pt" style="display:none">
  <div class="sb-section-label">Manage</div>
  <button class="sb-item active" onclick="nav('dashboard')" id="nav-dashboard"><span class="sb-icon">‚ö°</span>Dashboard</button>
  <button class="sb-item" onclick="nav('clients')" id="nav-clients"><span class="sb-icon">üë•</span>Clients<span class="sb-badge" id="sb-clients">0</span></button>
  <div class="sb-section-label">Plans</div>
  <button class="sb-item" onclick="nav('meal-plans')" id="nav-meal-plans"><span class="sb-icon">ü•ó</span>Meal Plans</button>
  <button class="sb-item" onclick="nav('workout-plans')" id="nav-workout-plans"><span class="sb-icon">üèãÔ∏è</span>Workout Plans</button>
  <div class="sb-section-label">Tools</div>
  <button class="sb-item" onclick="nav('shopping-lists')" id="nav-shopping-lists"><span class="sb-icon">üõí</span>Shopping Lists</button>
  <button class="sb-item" onclick="nav('favourites')" id="nav-favourites"><span class="sb-icon">‚ù§Ô∏è</span>Favourites</button>
  <button class="sb-item" onclick="nav('receipt-scanner')" id="nav-receipt-scanner"><span class="sb-icon">üì∏</span>Receipt Scanner</button>
  <button class="sb-item" onclick="nav('billing')" id="nav-billing"><span class="sb-icon">üí≥</span>Billing</button>
</nav>

<!-- SIDEBAR ‚Äî CLIENT VIEW -->
<nav class="sidebar" id="sidebar-client" style="display:none">
  <div class="sb-section-label">Today</div>
  <button class="sb-item active" onclick="nav('portal-home')" id="nav-portal-home"><span class="sb-icon">üè†</span>Home</button>
  <button class="sb-item" onclick="nav('portal-plan')" id="nav-portal-plan"><span class="sb-icon">üìã</span>My Plan</button>
  <div class="sb-section-label">Log</div>
  <button class="sb-item" onclick="nav('portal-meals')" id="nav-portal-meals"><span class="sb-icon">ü•ó</span>Log Meals</button>
  <button class="sb-item" onclick="nav('portal-workouts')" id="nav-portal-workouts"><span class="sb-icon">üèãÔ∏è</span>Log Workout</button>
  <button class="sb-item" onclick="nav('portal-progress')" id="nav-portal-progress"><span class="sb-icon">üìà</span>Progress</button>
  <div class="sb-section-label">My Stuff</div>
  <button class="sb-item" onclick="nav('portal-shopping')" id="nav-portal-shopping"><span class="sb-icon">üõí</span>Shopping List</button>
  <button class="sb-item" onclick="nav('receipt-scanner')" id="nav-receipt-scanner-c"><span class="sb-icon">üì∏</span>Receipt Scanner</button>
  <button class="sb-item" onclick="nav('portal-favourites')" id="nav-portal-favourites"><span class="sb-icon">‚ù§Ô∏è</span>Favourites</button>
</nav>

<div class="main" id="app-main">

<!-- ‚ïê‚ïê PT: DASHBOARD ‚ïê‚ïê -->
<div class="view active" id="view-dashboard">
  <div class="view-header">
    <div><div class="view-title" id="dash-greeting">Good morning</div><div class="view-sub" id="dash-sub">Welcome to FitMunch</div></div>
    <div class="view-actions"><button class="btn btn-green" onclick="openInviteModal()">+ Invite Client</button></div>
  </div>
  <div class="scroll-body">

    <!-- Metrics -->
    <div class="metrics-row">
      <div class="metric"><div class="metric-label">Active Clients</div><div class="metric-value mv-green" id="m-clients">0</div><div class="metric-sub">in your roster</div></div>
      <div class="metric"><div class="metric-label">Logged Today</div><div class="metric-value mv-blue" id="m-logged">0</div><div class="metric-sub">clients active</div></div>
      <div class="metric"><div class="metric-label">Need Check-in</div><div class="metric-value mv-amber" id="m-checkin">0</div><div class="metric-sub">3+ days quiet</div></div>
      <div class="metric"><div class="metric-label">This Month</div><div class="metric-value mv-purple" id="m-mrr">$0</div><div class="metric-sub">subscription revenue</div></div>
    </div>

    <!-- Feature tiles -->
    <div class="feat-tile-grid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px">
      <div class="feat-tile" onclick="nav('receipt-scanner')">
        <div class="ft-icon">üì∏</div>
        <div class="ft-label">Receipt Scanner</div>
        <div class="ft-sub">Snap your shop ‚Üí macros</div>
      </div>
      <div class="feat-tile" onclick="nav('clients')">
        <div class="ft-icon">üë•</div>
        <div class="ft-label">Clients</div>
        <div class="ft-sub">Manage your roster</div>
      </div>
      <div class="feat-tile" onclick="nav('meal-plans')">
        <div class="ft-icon">ü•ó</div>
        <div class="ft-label">Meal Plans</div>
        <div class="ft-sub">Build & assign plans</div>
      </div>
      <div class="feat-tile" onclick="nav('workout-plans')">
        <div class="ft-icon">üèãÔ∏è</div>
        <div class="ft-label">Workout Plans</div>
        <div class="ft-sub">Design programs</div>
      </div>
      <div class="feat-tile" onclick="nav('portal-meals')">
        <div class="ft-icon">üçΩÔ∏è</div>
        <div class="ft-label">Log My Meals</div>
        <div class="ft-sub">Track your own macros</div>
      </div>
      <div class="feat-tile" onclick="nav('portal-workouts')">
        <div class="ft-icon">üí™</div>
        <div class="ft-label">Log Workout</div>
        <div class="ft-sub">Track your training</div>
      </div>
      <div class="feat-tile" onclick="nav('shopping-lists')">
        <div class="ft-icon">üõí</div>
        <div class="ft-label">Shopping Lists</div>
        <div class="ft-sub">Auto-build from plans</div>
      </div>
      <div class="feat-tile" onclick="nav('portal-progress')">
        <div class="ft-icon">üìà</div>
        <div class="ft-label">My Progress</div>
        <div class="ft-sub">Weight & measurements</div>
      </div>
    </div>

    <!-- Two column: clients + invite CTA -->
    <div style="display:grid;grid-template-columns:2fr 1fr;gap:12px">
      <div class="card">
        <div class="card-header"><span class="card-title">Client Activity</span><button class="btn btn-ghost2 btn-sm" onclick="nav('clients')">View all ‚Üí</button></div>
        <div id="dash-client-list"><div style="padding:20px;text-align:center"><div class="loader"></div></div></div>
      </div>
      <div class="card" style="background:linear-gradient(135deg,#f0fdf4,#dcfce7);border-color:#bbf7d0">
        <div class="card-body" style="text-align:center;padding:20px">
          <div style="font-size:28px;margin-bottom:8px">üîó</div>
          <div style="font-size:.88rem;font-weight:800;color:#14532d;margin-bottom:6px">Invite your first client</div>
          <div style="font-size:.75rem;color:#166534;line-height:1.5;margin-bottom:14px">Generate an invite link ‚Äî they register and appear in your roster automatically.</div>
          <button class="btn btn-green" style="width:100%" onclick="openInviteModal()">Generate Invite Link</button>
          <div style="margin-top:10px;border-top:1px solid #bbf7d0;padding-top:10px">
            <div style="font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#16a34a;margin-bottom:6px">Outreach copy ready</div>
            <button class="btn btn-ghost2 btn-sm" style="width:100%;font-size:.72rem" onclick="toast('Outreach templates are in your Mission Control dashboard','warn')">View FB + IG templates ‚Üí</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê PT: CLIENTS ‚ïê‚ïê -->
<div class="view" id="view-clients">
  <div class="view-header">
    <div><div class="view-title">Clients</div><div class="view-sub" id="clients-sub">Loading‚Ä¶</div></div>
    <div class="view-actions"><button class="btn btn-green" onclick="openInviteModal()">+ Invite Client</button></div>
  </div>
  <div id="invite-banner" style="padding:0 20px;margin-top:12px;display:none">
    <div class="invite-banner">
      <span style="font-size:.82rem;font-weight:600">üì® Invite link ready:</span>
      <span class="invite-link" id="invite-link-text"></span>
      <button class="copy-btn" onclick="copyInvite()">Copy</button>
    </div>
  </div>
  <div class="scroll-body">
    <div class="card" id="clients-card">
      <div id="clients-list"><div style="padding:20px;text-align:center"><div class="loader"></div></div></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê PT: CLIENT DETAIL ‚ïê‚ïê -->
<div class="view" id="view-client-detail">
  <div class="detail-panel">
    <div class="detail-header">
      <button class="back-btn" onclick="nav('clients')">‚Üê Back</button>
      <div class="c-av" id="detail-av" style="width:32px;height:32px;font-size:.65rem"></div>
      <div style="flex:1"><div style="font-size:.9rem;font-weight:800" id="detail-name">Client</div><div style="font-size:.72rem;color:var(--text3)" id="detail-email"></div></div>
      <select class="form-select" id="detail-phase" style="width:130px" onchange="updateClientPhase()">
        <option value="deficit">Deficit phase</option><option value="maintain">Maintain phase</option><option value="bulk">Bulk phase</option>
      </select>
      <button class="btn btn-green btn-sm" onclick="openAssignModal()">Assign Plan</button>
    </div>
    <div class="detail-tabs">
      <div class="detail-tab active" onclick="detailTab('overview',this)">Overview</div>
      <div class="detail-tab" onclick="detailTab('meals',this)">Meals</div>
      <div class="detail-tab" onclick="detailTab('workouts',this)">Workouts</div>
      <div class="detail-tab" onclick="detailTab('progress',this)">Progress</div>
    </div>
    <div class="detail-body" id="detail-body">
      <div style="text-align:center;padding:20px"><div class="loader"></div></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê PT: MEAL PLANS ‚ïê‚ïê -->
<div class="view" id="view-meal-plans">
  <div class="view-header">
    <div><div class="view-title">Meal Plans</div><div class="view-sub">Create plans and assign them to clients.</div></div>
    <div class="view-actions"><button class="btn btn-green" onclick="openModal('modal-mealplan')">+ New Plan</button></div>
  </div>
  <div class="scroll-body">
    <div class="plan-grid" id="meal-plans-grid">
      <div style="grid-column:1/-1;padding:20px;text-align:center"><div class="loader"></div></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê PT: WORKOUT PLANS ‚ïê‚ïê -->
<div class="view" id="view-workout-plans">
  <div class="view-header">
    <div><div class="view-title">Workout Plans</div><div class="view-sub">Design programs and assign to clients.</div></div>
    <div class="view-actions"><button class="btn btn-green" onclick="openModal('modal-workoutplan')">+ New Plan</button></div>
  </div>
  <div class="scroll-body">
    <div class="plan-grid" id="workout-plans-grid">
      <div style="grid-column:1/-1;padding:20px;text-align:center"><div class="loader"></div></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê PT: SHOPPING LISTS ‚ïê‚ïê -->
<div class="view" id="view-shopping-lists">
  <div class="view-header">
    <div><div class="view-title">Shopping Lists</div><div class="view-sub">Auto-generated from meal plans.</div></div>
    <div class="view-actions"><button class="btn btn-green" onclick="openModal('modal-generate-shopping')">Generate from Plan</button></div>
  </div>
  <div class="scroll-body" id="shopping-lists-body">
    <div style="padding:20px;text-align:center"><div class="loader"></div></div>
  </div>
</div>

<!-- ‚ïê‚ïê PT: FAVOURITES ‚ïê‚ïê -->
<div class="view" id="view-favourites">
  <div class="view-header"><div><div class="view-title">Favourites</div><div class="view-sub">Saved meals, foods and workouts.</div></div></div>
  <div class="scroll-body">
    <div class="fav-grid" id="pt-favs-grid">
      <div style="grid-column:1/-1;padding:20px;text-align:center"><div class="loader"></div></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê PT: BILLING ‚ïê‚ïê -->
<div class="view" id="view-billing">
  <div class="view-header"><div><div class="view-title">Billing</div><div class="view-sub">Manage your subscription.</div></div></div>
  <div class="scroll-body">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;max-width:700px">
      <div class="card" style="border:2px solid var(--border)">
        <div class="card-body">
          <div style="font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:8px">Starter</div>
          <div style="font-size:1.8rem;font-weight:900;letter-spacing:-.04em">$59<span style="font-size:.85rem;font-weight:500;color:var(--text2)">/mo AUD</span></div>
          <div style="font-size:.78rem;color:var(--text2);margin:10px 0">Up to 10 clients</div>
          <button class="btn btn-ghost2" style="display:block;width:100%;margin-top:10px" onclick="startCheckout('starter')">Select plan</button>
        </div>
      </div>
      <div class="card" style="border:2px solid var(--green2)">
        <div class="card-body">
          <div style="font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--green2);margin-bottom:8px">Pro ‚Äî Most popular</div>
          <div style="font-size:1.8rem;font-weight:900;letter-spacing:-.04em">$99<span style="font-size:.85rem;font-weight:500;color:var(--text2)">/mo AUD</span></div>
          <div style="font-size:.78rem;color:var(--text2);margin:10px 0">Unlimited clients + all features</div>
          <button class="btn btn-green" style="display:block;width:100%;margin-top:10px" onclick="startCheckout('pro')">Select plan ‚Üí</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê CLIENT: HOME ‚ïê‚ïê -->
<div class="view" id="view-portal-home">
  <div class="view-header">
    <div><div class="view-title" id="portal-greeting">Good morning</div><div class="view-sub" id="portal-pt-name">Loading your data‚Ä¶</div></div>
  </div>
  <div class="scroll-body">
    <div class="metrics-row">
      <div class="metric"><div class="metric-label">Meals Today</div><div class="metric-value mv-green" id="pm-meals">0</div><div class="metric-sub">logged</div></div>
      <div class="metric"><div class="metric-label">Calories</div><div class="metric-value mv-blue" id="pm-cals">0</div><div class="metric-sub">today</div></div>
      <div class="metric"><div class="metric-label">Workouts</div><div class="metric-value mv-purple" id="pm-workouts">0</div><div class="metric-sub">this week</div></div>
      <div class="metric"><div class="metric-label">Streak</div><div class="metric-value mv-amber" id="pm-streak">0</div><div class="metric-sub">days logging</div></div>
    </div>
    <!-- Goals banner (hidden until goals set) -->
    <div id="portal-goal-banner" style="display:none;margin-bottom:14px"></div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="card">
        <div class="card-header"><span class="card-title">My Meal Plan</span><button class="btn btn-ghost2 btn-sm" onclick="nav('portal-plan')">View</button></div>
        <div class="card-body" id="home-mealplan"><span style="color:var(--text3);font-size:.78rem">No plan assigned yet</span></div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">My Workout Plan</span><button class="btn btn-ghost2 btn-sm" onclick="nav('portal-plan')">View</button></div>
        <div class="card-body" id="home-workoutplan"><span style="color:var(--text3);font-size:.78rem">No plan assigned yet</span></div>
      </div>
    </div>
    <!-- Onboarding CTA for new users -->
    <div id="portal-onboard-cta" style="margin-top:14px;background:linear-gradient(135deg,#f0fdf4,#dcfce7);border:1px solid #bbf7d0;border-radius:12px;padding:20px;text-align:center">
      <div style="font-size:28px;margin-bottom:8px">üì∏</div>
      <div style="font-size:.92rem;font-weight:800;color:#14532d;margin-bottom:6px">Scan your first receipt</div>
      <div style="font-size:.78rem;color:#166534;line-height:1.5;margin-bottom:14px">Snap your Woolies or Coles receipt ‚Äî get your full macro breakdown in seconds.</div>
      <button class="btn btn-green" onclick="nav('receipt-scanner')">Try receipt scanner ‚Üí</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê CLIENT: MY PLAN ‚ïê‚ïê -->
<div class="view" id="view-portal-plan">
  <div class="view-header"><div><div class="view-title">My Plan</div><div class="view-sub">Assigned by your trainer.</div></div></div>
  <div class="scroll-body" id="portal-plan-body">
    <div style="padding:20px;text-align:center"><div class="loader"></div></div>
  </div>
</div>

<!-- ‚ïê‚ïê CLIENT: LOG MEALS ‚ïê‚ïê -->
<div class="view" id="view-portal-meals">
  <div class="view-header">
    <div><div class="view-title">Log Meals</div><div class="view-sub" id="meals-date-label"></div></div>
    <div class="view-actions">
      <input type="date" class="form-input" id="meals-date" style="font-size:.78rem" onchange="loadTodayMeals()"/>
      <button class="btn btn-green" onclick="openModal('modal-log-meal')">+ Add Food</button>
    </div>
  </div>
  <div class="scroll-body">
    <div style="background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:12px 16px;margin-bottom:14px;display:flex;gap:20px">
      <div style="text-align:center"><div style="font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3)">Calories</div><div style="font-size:1.3rem;font-weight:800" id="meals-total-cals">0</div></div>
      <div style="text-align:center"><div style="font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3)">Protein</div><div style="font-size:1.3rem;font-weight:800;color:var(--blue)" id="meals-protein">0g</div></div>
      <div style="text-align:center"><div style="font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3)">Carbs</div><div style="font-size:1.3rem;font-weight:800;color:var(--amber)" id="meals-carbs">0g</div></div>
      <div style="text-align:center"><div style="font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3)">Fat</div><div style="font-size:1.3rem;font-weight:800;color:var(--red)" id="meals-fat">0g</div></div>
    </div>
    <div id="meals-log-body">
      <div class="meal-section"><div class="meal-section-title">üåÖ Breakfast</div><div id="log-breakfast" class="meal-entries"></div></div>
      <div class="meal-section"><div class="meal-section-title">‚òÄÔ∏è Lunch</div><div id="log-lunch" class="meal-entries"></div></div>
      <div class="meal-section"><div class="meal-section-title">üåô Dinner</div><div id="log-dinner" class="meal-entries"></div></div>
      <div class="meal-section"><div class="meal-section-title">üçé Snack</div><div id="log-snack" class="meal-entries"></div></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê CLIENT: LOG WORKOUT ‚ïê‚ïê -->
<div class="view" id="view-portal-workouts">
  <div class="view-header">
    <div><div class="view-title">Log Workout</div><div class="view-sub">Track your training sessions.</div></div>
    <div class="view-actions"><button class="btn btn-green" onclick="openModal('modal-log-workout')">+ Log Session</button></div>
  </div>
  <div class="scroll-body">
    <div class="card">
      <div class="card-header"><span class="card-title">Recent Sessions</span></div>
      <div id="workout-log-body"><div style="padding:20px;text-align:center"><div class="loader"></div></div></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê CLIENT: PROGRESS ‚ïê‚ïê -->
<div class="view" id="view-portal-progress">
  <div class="view-header">
    <div><div class="view-title">Progress</div><div class="view-sub">Track your body measurements and weight over time.</div></div>
    <div class="view-actions"><button class="btn btn-green" onclick="openModal('modal-log-progress')">+ Log Measurement</button></div>
  </div>
  <div class="scroll-body">
    <div class="card" style="margin-bottom:14px">
      <div class="card-header"><span class="card-title">Recent Measurements</span></div>
      <div id="progress-log-body"><div style="padding:20px;text-align:center"><div class="loader"></div></div></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê CLIENT: SHOPPING LIST ‚ïê‚ïê -->
<div class="view" id="view-portal-shopping">
  <div class="view-header">
    <div><div class="view-title">Shopping List</div><div class="view-sub">Generated from your assigned meal plan.</div></div>
  </div>
  <div class="scroll-body" id="portal-shopping-body">
    <div style="padding:20px;text-align:center"><div class="loader"></div></div>
  </div>
</div>

<!-- ‚ïê‚ïê CLIENT: FAVOURITES ‚ïê‚ïê -->
<div class="view" id="view-portal-favourites">
  <div class="view-header"><div><div class="view-title">Favourites</div><div class="view-sub">Foods and workouts you've loved.</div></div></div>
  <div class="scroll-body">
    <div class="fav-grid" id="client-favs-grid">
      <div style="grid-column:1/-1;padding:20px;text-align:center"><div class="loader"></div></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê RECEIPT SCANNER ‚ïê‚ïê -->
<div class="view" id="view-receipt-scanner">
  <div class="view-header">
    <div><div class="view-title">üì∏ Receipt Scanner</div><div class="view-sub">Snap your supermarket receipt ‚Äî get your full week's macro breakdown instantly.</div></div>
  </div>
  <div class="scroll-body">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <!-- Upload Panel -->
      <div>
        <div class="card" style="margin-bottom:14px">
          <div class="card-header"><span class="card-title">Upload Receipt</span></div>
          <div class="card-body">
            <div id="receipt-drop-zone" onclick="document.getElementById('receipt-file').click()"
              style="border:2px dashed #bbf7d0;border-radius:10px;padding:32px;text-align:center;cursor:pointer;background:#f0fdf4;transition:all .15s">
              <div style="font-size:32px;margin-bottom:8px">üì∏</div>
              <div style="font-size:.88rem;font-weight:700;color:var(--green2);margin-bottom:4px">Tap to choose a photo</div>
              <div style="font-size:.75rem;color:var(--text3)">JPG, PNG, HEIC ‚Äî max 10MB</div>
            </div>
            <input type="file" id="receipt-file" accept="image/*" style="display:none" onchange="receiptFileSelected(event)"/>
            <div id="receipt-preview" style="display:none;margin-top:12px">
              <img id="receipt-img-preview" style="width:100%;border-radius:8px;max-height:200px;object-fit:cover;border:1px solid var(--border)"/>
              <div style="display:flex;gap:8px;margin-top:10px">
                <button class="btn btn-green" style="flex:1" onclick="scanReceipt()" id="scan-btn">Scan Receipt ‚Üí</button>
                <button class="btn btn-ghost2" onclick="clearReceipt()">‚úï</button>
              </div>
            </div>
          </div>
        </div>
        <div class="card" id="share-card" style="display:none">
          <div class="card-header"><span class="card-title">Share to TikTok &amp; IG</span></div>
          <div class="card-body">
            <textarea id="share-text-box" class="form-input" rows="7" style="width:100%;font-size:.78rem;line-height:1.6"></textarea>
            <div style="display:flex;gap:8px;margin-top:10px">
              <button class="btn btn-green" style="flex:1" onclick="copyShareText()">üìã Copy caption</button>
              <button class="btn btn-ghost2" onclick="shareNative()">üì≤ Share</button>
            </div>
            <button class="btn btn-ghost2" style="width:100%;margin-top:8px" onclick="downloadScanCard()">‚¨áÔ∏è Download share card (PNG)</button>
            <div style="font-size:.72rem;color:var(--text3);margin-top:8px">Download the card + copy caption ‚Üí post to TikTok or Instagram Reels.</div>
          </div>
        </div>
      </div>
      <!-- Results Panel -->
      <div>
        <div id="scan-loading" style="display:none;text-align:center;padding:40px">
          <div class="loader" style="width:24px;height:24px;border-width:3px;margin:0 auto 12px"></div>
          <div style="font-size:.85rem;font-weight:600;color:var(--text2)">Reading your receipt‚Ä¶</div>
          <div style="font-size:.75rem;color:var(--text3);margin-top:4px">Claude AI is scanning every item</div>
        </div>
        <div id="scan-empty" style="text-align:center;padding:60px 20px">
          <div style="font-size:36px;margin-bottom:12px">üßæ</div>
          <div style="font-size:.88rem;font-weight:600;color:var(--text2);margin-bottom:4px">Upload a receipt to get started</div>
          <div style="font-size:.78rem;color:var(--text3)">Works with Woolworths, Coles, Aldi, IGA, Costco</div>
        </div>
        <div id="scan-results" style="display:none">
          <!-- Score card -->
          <div style="background:linear-gradient(135deg,#0a1a0a,#0d2d1a);border-radius:12px;padding:20px;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between">
            <div>
              <div style="font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:#86efac;margin-bottom:4px">Weekly haul score</div>
              <div style="font-size:3rem;font-weight:900;color:#22c55e;letter-spacing:-.06em" id="scan-grade">‚Äî</div>
            </div>
            <div style="display:flex;gap:16px">
              <div style="text-align:center"><div style="font-size:1.4rem;font-weight:900;color:#fff" id="scan-protein">0g</div><div style="font-size:.65rem;color:#86efac">Protein</div></div>
              <div style="text-align:center"><div style="font-size:1.4rem;font-weight:900;color:#fff" id="scan-cals">0</div><div style="font-size:.65rem;color:#86efac">Calories</div></div>
              <div style="text-align:center"><div style="font-size:1.4rem;font-weight:900;color:#fff" id="scan-items">0</div><div style="font-size:.65rem;color:#86efac">Items</div></div>
            </div>
          </div>
          <!-- Macro bar -->
          <div class="card" style="margin-bottom:14px">
            <div class="card-body" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;text-align:center">
              <div><div style="font-size:1.1rem;font-weight:800;color:#3b82f6" id="scan-carbs">0g</div><div style="font-size:.65rem;color:var(--text3)">Carbs</div></div>
              <div><div style="font-size:1.1rem;font-weight:800;color:#f59e0b" id="scan-fat">0g</div><div style="font-size:.65rem;color:var(--text3)">Fat</div></div>
              <div><div style="font-size:1.1rem;font-weight:800;color:var(--text2)" id="scan-item-count">0</div><div style="font-size:.65rem;color:var(--text3)">Food items</div></div>
            </div>
          </div>
          <!-- Item list -->
          <div class="card">
            <div class="card-header"><span class="card-title">Items scanned</span></div>
            <div id="scan-items-list" style="max-height:260px;overflow-y:auto"></div>
          </div>
          <!-- Log to meals -->
          <div class="card" id="scan-log-meals-box" style="display:none;margin-top:14px"></div>
        </div>
      </div>
    </div>
  </div>
</div>

</div><!-- /main -->
</div><!-- /shell -->

<!-- ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ -->
<div class="modal-overlay" id="modal-invite" onclick="closeOnOverlay(event)">
  <div class="modal">
    <div class="modal-title">Invite a Client<button class="modal-close" onclick="closeModal('modal-invite')">‚úï</button></div>
    <div style="font-size:.82rem;color:var(--text2);margin-bottom:14px">Enter their email (optional) and share the link. They'll register as your client automatically.</div>
    <div class="form-field" style="margin-bottom:14px"><label class="form-label">Client Email (optional)</label><input class="form-input" id="inv-email" type="email" placeholder="client@example.com"/></div>
    <div class="modal-actions">
      <button class="btn btn-ghost2" onclick="closeModal('modal-invite')">Cancel</button>
      <button class="btn btn-green" onclick="createInvite()">Generate Invite Link</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-assign" onclick="closeOnOverlay(event)">
  <div class="modal">
    <div class="modal-title">Assign Plan to Client<button class="modal-close" onclick="closeModal('modal-assign')">‚úï</button></div>
    <div class="form-row">
      <div class="form-field"><label class="form-label">Plan Type</label>
        <select class="form-select" id="assign-type"><option value="meal">Meal Plan</option><option value="workout">Workout Plan</option></select></div>
    </div>
    <div class="form-field" style="margin-top:10px"><label class="form-label">Select Plan</label>
      <select class="form-select" id="assign-plan-select"><option>Loading‚Ä¶</option></select></div>
    <div class="modal-actions">
      <button class="btn btn-ghost2" onclick="closeModal('modal-assign')">Cancel</button>
      <button class="btn btn-green" onclick="doAssignPlan()">Assign Plan</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-mealplan" onclick="closeOnOverlay(event)">
  <div class="modal">
    <div class="modal-title">New Meal Plan<button class="modal-close" onclick="closeModal('modal-mealplan')">‚úï</button></div>
    <div class="form-field" style="margin-bottom:10px"><label class="form-label">Plan Name</label><input class="form-input" id="mp-name" placeholder="e.g. 12-week deficit plan"/></div>
    <div class="form-row">
      <div class="form-field"><label class="form-label">Goal</label>
        <select class="form-select" id="mp-goal"><option value="weight_loss">Weight Loss</option><option value="maintenance">Maintenance</option><option value="muscle_gain">Muscle Gain</option></select></div>
      <div class="form-field"><label class="form-label">Daily Calories</label><input class="form-input" id="mp-cals" type="number" placeholder="1800"/></div>
    </div>
    <div class="form-field" style="margin-top:10px"><label class="form-label">Description</label><textarea class="form-input" id="mp-desc" rows="2" placeholder="Describe what this plan is for‚Ä¶"></textarea></div>
    <div class="modal-actions">
      <button class="btn btn-ghost2" onclick="closeModal('modal-mealplan')">Cancel</button>
      <button class="btn btn-green" onclick="saveMealPlan()">Create Plan</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-workoutplan" onclick="closeOnOverlay(event)">
  <div class="modal">
    <div class="modal-title">New Workout Plan<button class="modal-close" onclick="closeModal('modal-workoutplan')">‚úï</button></div>
    <div class="form-field" style="margin-bottom:10px"><label class="form-label">Plan Name</label><input class="form-input" id="wp-name" placeholder="e.g. 5-day PPL program"/></div>
    <div class="form-row">
      <div class="form-field"><label class="form-label">Level</label>
        <select class="form-select" id="wp-level"><option value="beginner">Beginner</option><option value="intermediate">Intermediate</option><option value="advanced">Advanced</option></select></div>
      <div class="form-field"><label class="form-label">Days/Week</label><input class="form-input" id="wp-freq" type="number" placeholder="4" min="1" max="7"/></div>
    </div>
    <div class="form-field" style="margin-top:10px"><label class="form-label">Description</label><textarea class="form-input" id="wp-desc" rows="2" placeholder="What does this program focus on?"></textarea></div>
    <div class="modal-actions">
      <button class="btn btn-ghost2" onclick="closeModal('modal-workoutplan')">Cancel</button>
      <button class="btn btn-green" onclick="saveWorkoutPlan()">Create Plan</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-generate-shopping" onclick="closeOnOverlay(event)">
  <div class="modal">
    <div class="modal-title">Generate Shopping List<button class="modal-close" onclick="closeModal('modal-generate-shopping')">‚úï</button></div>
    <div class="form-field" style="margin-bottom:10px"><label class="form-label">From Meal Plan</label>
      <select class="form-select" id="gen-plan-select"><option>Loading‚Ä¶</option></select></div>
    <div class="form-field"><label class="form-label">List Name</label><input class="form-input" id="gen-list-name" placeholder="Leave blank for auto-name"/></div>
    <div class="modal-actions">
      <button class="btn btn-ghost2" onclick="closeModal('modal-generate-shopping')">Cancel</button>
      <button class="btn btn-green" onclick="generateShoppingList()">Generate List</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-log-meal" onclick="closeOnOverlay(event)">
  <div class="modal">
    <div class="modal-title">Log Food<button class="modal-close" onclick="closeModal('modal-log-meal')">‚úï</button></div>
    <div class="form-row">
      <div class="form-field" style="grid-column:1/-1"><label class="form-label">Food Name</label><input class="form-input" id="lm-food" placeholder="e.g. Chicken breast, 150g"/></div>
    </div>
    <div class="form-row" style="margin-top:10px">
      <div class="form-field"><label class="form-label">Meal</label>
        <select class="form-select" id="lm-meal"><option value="breakfast">Breakfast</option><option value="lunch">Lunch</option><option value="dinner">Dinner</option><option value="snack">Snack</option></select></div>
      <div class="form-field"><label class="form-label">Calories</label><input class="form-input" id="lm-cals" type="number" placeholder="0"/></div>
    </div>
    <div class="form-row" style="margin-top:10px">
      <div class="form-field"><label class="form-label">Protein (g)</label><input class="form-input" id="lm-protein" type="number" placeholder="0"/></div>
      <div class="form-field"><label class="form-label">Carbs (g)</label><input class="form-input" id="lm-carbs" type="number" placeholder="0"/></div>
    </div>
    <div class="form-row" style="margin-top:10px">
      <div class="form-field"><label class="form-label">Fat (g)</label><input class="form-input" id="lm-fat" type="number" placeholder="0"/></div>
      <div class="form-field"><label class="form-label">Serving Size</label><input class="form-input" id="lm-serving" placeholder="150g"/></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost2" onclick="closeModal('modal-log-meal')">Cancel</button>
      <button class="btn btn-green" onclick="logMealEntry()">Log It</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-log-workout" onclick="closeOnOverlay(event)">
  <div class="modal">
    <div class="modal-title">Log Workout Session<button class="modal-close" onclick="closeModal('modal-log-workout')">‚úï</button></div>
    <div class="form-field" style="margin-bottom:10px"><label class="form-label">Workout Type</label><input class="form-input" id="lw-type" placeholder="e.g. Upper body, Leg day, Cardio"/></div>
    <div class="form-row">
      <div class="form-field"><label class="form-label">Duration (min)</label><input class="form-input" id="lw-duration" type="number" placeholder="60"/></div>
      <div class="form-field"><label class="form-label">Calories Burned</label><input class="form-input" id="lw-cals" type="number" placeholder="0"/></div>
    </div>
    <div class="form-field" style="margin-top:10px"><label class="form-label">Notes</label><textarea class="form-input" id="lw-notes" rows="2" placeholder="How did it go? Any PRs?"></textarea></div>
    <div class="modal-actions">
      <button class="btn btn-ghost2" onclick="closeModal('modal-log-workout')">Cancel</button>
      <button class="btn btn-green" onclick="logWorkoutEntry()">Log Session</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-log-progress" onclick="closeOnOverlay(event)">
  <div class="modal">
    <div class="modal-title">Log Measurement<button class="modal-close" onclick="closeModal('modal-log-progress')">‚úï</button></div>
    <div class="form-row">
      <div class="form-field"><label class="form-label">Body Weight (kg)</label><input class="form-input" id="lp-weight" type="number" step="0.1" placeholder="75.0"/></div>
      <div class="form-field"><label class="form-label">Body Fat %</label><input class="form-input" id="lp-bf" type="number" step="0.1" placeholder="20"/></div>
    </div>
    <div class="form-row" style="margin-top:10px">
      <div class="form-field"><label class="form-label">Waist (cm)</label><input class="form-input" id="lp-waist" type="number" step="0.1" placeholder="80"/></div>
      <div class="form-field"><label class="form-label">Chest (cm)</label><input class="form-input" id="lp-chest" type="number" step="0.1" placeholder="100"/></div>
    </div>
    <div class="form-field" style="margin-top:10px"><label class="form-label">Notes</label><textarea class="form-input" id="lp-notes" rows="2" placeholder="How are you feeling?"></textarea></div>
    <div class="modal-actions">
      <button class="btn btn-ghost2" onclick="closeModal('modal-log-progress')">Cancel</button>
      <button class="btn btn-green" onclick="logProgressEntry()">Save</button>
    </div>
  </div>
</div>

<!-- GOALS ONBOARDING MODAL -->
<div class="modal-overlay" id="modal-goals" style="z-index:300" onclick="closeOnOverlay(event)">
  <div class="modal" style="max-width:420px">
    <div class="modal-title">üëã Let's set your goals<button class="modal-close" onclick="closeModal('modal-goals')">‚úï</button></div>
    <p style="font-size:.82rem;color:var(--text2);line-height:1.6;margin-bottom:16px">30 seconds. We'll track your progress and show how you're tracking.</p>
    <div class="form-field">
      <label class="form-label">My goal</label>
      <select id="goal-type" class="form-select">
        <option value="lose_weight">üî• Lose weight</option>
        <option value="muscle_gain">üí™ Build muscle</option>
        <option value="maintain">‚öñÔ∏è Maintain weight</option>
        <option value="general_fitness">üèÉ General fitness</option>
      </select>
    </div>
    <div class="form-row" style="margin-top:10px">
      <div class="form-field">
        <label class="form-label">Daily calories</label>
        <input type="number" id="goal-calories" class="form-input" placeholder="e.g. 2000" min="1000" max="5000"/>
      </div>
      <div class="form-field">
        <label class="form-label">Protein target (g)</label>
        <input type="number" id="goal-protein" class="form-input" placeholder="e.g. 150" min="50" max="400"/>
      </div>
    </div>
    <div class="form-field" style="margin-top:10px">
      <label class="form-label">Current weight (kg) <span style="color:var(--text3);font-weight:400">optional</span></label>
      <input type="number" id="goal-weight" class="form-input" placeholder="e.g. 80" step="0.1"/>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost2" onclick="closeModal('modal-goals')">Skip for now</button>
      <button class="btn btn-green" onclick="saveGoals()">Save goals ‚Üí</button>
    </div>
  </div>
</div>

<!-- MOBILE BOTTOM NAV -->
<div class="mobile-nav" id="mobile-nav">
  <div class="mob-nav-items" id="mob-nav-items"><!-- injected by JS --></div>
</div>
<div class="mob-nav-more" id="mob-nav-more"><!-- injected by JS --></div>

<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const S = {
  token: localStorage.getItem('fm_token'),
  goals: null,
  lastScan: null,
  user: null,
  role: 'pt',
  clients: [],
  mealPlans: [],
  workoutPlans: [],
  shoppingLists: [],
  favourites: [],
  currentClient: null,
  currentClientData: null,
  portalData: null,
  inviteLink: null,
  todayMeals: [],
  mealsDate: new Date().toISOString().split('T')[0],
};

const API = (path, opts={}) => {
  const headers = { 'Content-Type': 'application/json', Authorization: 'Bearer ' + S.token };
  return fetch('/api' + path, { ...opts, headers: { ...headers, ...(opts.headers||{}) } }).then(r => r.json());
};

// ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚îÄ‚îÄ VISIBLE ERROR DISPLAY (debug) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showErr(msg) {
  console.error('[FitMunch]', msg);
  let el = document.getElementById('_dbg');
  if (!el) {
    el = document.createElement('div');
    el.id = '_dbg';
    el.style.cssText = 'position:fixed;bottom:0;left:0;right:0;background:#7f1d1d;color:#fca5a5;font-size:11px;padding:8px 14px;z-index:99999;font-family:monospace;max-height:120px;overflow-y:auto';
    document.body.appendChild(el);
  }
  el.innerHTML += '<div>‚ö† ' + msg + '</div>';
}
window.onerror = (msg, src, line) => showErr(msg + ' (line '+line+')');
window.onunhandledrejection = e => showErr('Promise: ' + (e.reason?.message || e.reason));

async function boot() {
  if (!S.token) { window.location.href = '/login.html'; return; }
  try {
    const me = await API('/auth/me');
    if (!me.success) { logout(); return; }
    S.user = me.user;
    S.role = me.user.role || 'pt';
    // Update nav
    document.getElementById('nav-name').textContent = me.user.name.split(' ')[0];
    document.getElementById('nav-av').textContent = me.user.name.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
    if (me.user.subscriptionTier && me.user.subscriptionTier !== 'free') {
      const badge = document.getElementById('nav-plan-badge');
      badge.textContent = me.user.subscriptionTier.charAt(0).toUpperCase()+me.user.subscriptionTier.slice(1);
      badge.style.display = '';
    } else {
      document.getElementById('btn-upgrade').style.display = '';
    }
    // Show correct sidebar
    if (S.role === 'client') {
      document.getElementById('sidebar-client').style.display = 'flex';
      setupClientPortal();
    } else {
      document.getElementById('sidebar-pt').style.display = 'flex';
      setupPT();
    }
  } catch { logout(); }
}

function logout() {
  localStorage.removeItem('fm_token');
  window.location.href = '/login.html';
}

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentView = '';
function nav(id) {
  try {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.querySelectorAll('.sb-item').forEach(b => b.classList.remove('active'));
    const view = document.getElementById('view-'+id);
    if (!view) { console.error('nav: no view found for id='+id); return; }
    view.classList.add('active');
    const btn = document.getElementById('nav-'+id);
    if (btn) btn.classList.add('active');
    // Sync mobile nav
    if (moreOpen) { moreOpen=false; const me=document.getElementById('mob-nav-more'); if(me) me.classList.remove('open'); }
    document.querySelectorAll('.mob-nav-btn').forEach(b => b.classList.remove('active'));
    const mobBtn = document.getElementById('mob-nav-'+id);
    if (mobBtn) mobBtn.classList.add('active');
    currentView = id;
    // Lazy load
    if (id === 'clients' && !S.clients.length) loadClients();
    if (id === 'meal-plans') loadMealPlans();
    if (id === 'workout-plans') loadWorkoutPlans();
    if (id === 'shopping-lists') loadShoppingLists();
    if (id === 'favourites' || id === 'portal-favourites') loadFavourites();
    if (id === 'portal-meals') { initMealDate(); loadTodayMeals(); }
    if (id === 'portal-workouts') loadWorkoutLog();
    if (id === 'portal-progress') loadProgressLog();
    if (id === 'portal-plan') renderPortalPlan();
    if (id === 'portal-shopping') renderPortalShopping();
  } catch(e) { showErr('nav('+id+'): '+e.message); }
}

// ‚îÄ‚îÄ MODAL HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
function closeOnOverlay(e) { if(e.target===e.currentTarget) e.currentTarget.classList.remove('open'); }
function openInviteModal() { openModal('modal-invite'); }

// ‚îÄ‚îÄ PT SETUP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚îÄ‚îÄ MOBILE NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let moreOpen = false;
function setupMobileNav(role) {
  const ptMain = [
    {id:'dashboard', icon:'‚ö°', label:'Home'},
    {id:'clients',   icon:'üë•', label:'Clients'},
    {id:'meal-plans',icon:'ü•ó', label:'Plans'},
    {id:'receipt-scanner',icon:'üì∏',label:'Scanner'},
    {id:'__more',   icon:'‚ò∞',  label:'More'},
  ];
  const ptMore = [
    {id:'workout-plans', icon:'üèãÔ∏è', label:'Workout Plans'},
    {id:'shopping-lists',icon:'üõí', label:'Shopping'},
    {id:'favourites',    icon:'‚ù§Ô∏è', label:'Favourites'},
    {id:'billing',       icon:'üí≥', label:'Billing'},
  ];
  const clientMain = [
    {id:'portal-home',      icon:'üè†', label:'Home'},
    {id:'portal-meals',     icon:'üçΩÔ∏è', label:'Log Meals'},
    {id:'portal-workouts',  icon:'üí™', label:'Workout'},
    {id:'portal-progress',  icon:'üìà', label:'Progress'},
    {id:'__more',           icon:'‚ò∞',  label:'More'},
  ];
  const clientMore = [
    {id:'portal-plan',      icon:'üìã', label:'My Plan'},
    {id:'portal-shopping',  icon:'üõí', label:'Shopping'},
    {id:'portal-favourites',icon:'‚ù§Ô∏è', label:'Favourites'},
    {id:'receipt-scanner',  icon:'üì∏', label:'Receipt'},
  ];
  const mainItems = role === 'client' ? clientMain : ptMain;
  const moreItems = role === 'client' ? clientMore : ptMore;
  const itemsEl = document.getElementById('mob-nav-items');
  const moreEl  = document.getElementById('mob-nav-more');
  itemsEl.innerHTML = mainItems.map(item => {
    if (item.id === '__more') return `<button class="mob-nav-btn" id="mob-more-toggle" onclick="toggleMobMore()"><span class="mn-icon">${item.icon}</span>${item.label}</button>`;
    return `<button class="mob-nav-btn" id="mob-nav-${item.id}" onclick="mobNav('${item.id}')"><span class="mn-icon">${item.icon}</span>${item.label}</button>`;
  }).join('');
  moreEl.innerHTML = moreItems.map(item =>
    `<button class="mob-more-btn" onclick="mobNav('${item.id}')">${item.icon} ${item.label}</button>`
  ).join('') + `<button class="mob-more-btn" onclick="logout()">üö™ Sign Out</button>`;
  // Highlight first active
  const firstId = role === 'client' ? 'portal-home' : 'dashboard';
  const firstBtn = document.getElementById('mob-nav-'+firstId);
  if (firstBtn) firstBtn.classList.add('active');
}
function toggleMobMore() {
  const moreEl = document.getElementById('mob-nav-more');
  moreOpen = !moreOpen;
  moreEl.classList.toggle('open', moreOpen);
  const toggle = document.getElementById('mob-more-toggle');
  if (toggle) toggle.classList.toggle('active', moreOpen);
}
function mobNav(id) {
  // Close more drawer
  moreOpen = false;
  document.getElementById('mob-nav-more').classList.remove('open');
  const toggle = document.getElementById('mob-more-toggle');
  if (toggle) toggle.classList.remove('active');
  // Highlight active
  document.querySelectorAll('.mob-nav-btn').forEach(b => b.classList.remove('active'));
  const activeBtn = document.getElementById('mob-nav-'+id);
  if (activeBtn) activeBtn.classList.add('active');
  // Navigate
  nav(id);
}

async function setupPT() {
  const hour = new Date().getHours();
  const greet = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
  document.getElementById('dash-greeting').textContent = greet + ', ' + S.user.name.split(' ')[0] + ' üëã';
  setupMobileNav('pt');
  await loadClients();
  loadMealPlans();
}

async function loadClients() {
  try {
    const r = await API('/clients');
    S.clients = r.clients || [];
    // Update sidebar badge
    document.getElementById('sb-clients').textContent = S.clients.length;
    document.getElementById('clients-sub').textContent = S.clients.length + ' client' + (S.clients.length!==1?'s':'');
    renderClientList(S.clients, 'clients-list');
    renderClientList(S.clients.slice(0,5), 'dash-client-list');
    // Dashboard metrics
    document.getElementById('m-clients').textContent = S.clients.length;
    const logged = S.clients.filter(c => c.meals_7d > 0 || c.workouts_7d > 0).length;
    document.getElementById('m-logged').textContent = logged;
    const needCheckin = S.clients.filter(c => {
      if (!c.last_logged) return true;
      return (Date.now() - new Date(c.last_logged)) > 3*86400000;
    }).length;
    document.getElementById('m-checkin').textContent = needCheckin;
    if (needCheckin > 0) document.getElementById('sb-clients').className = 'sb-badge alert';
  } catch(e) { console.error(e); }
}

const COLORS = ['#7c3aed','#0891b2','#dc2626','#d97706','#059669','#db2777','#2563eb','#65a30d'];
function clientColor(name) { let h=0; for(const c of name) h+=c.charCodeAt(0); return COLORS[h%COLORS.length]; }
function initials(name) { return name.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase(); }
function timeAgo(ts) {
  if (!ts) return 'Never';
  const d = Math.floor((Date.now()-new Date(ts))/86400000);
  if (d===0) return 'Today'; if (d===1) return 'Yesterday'; return d+'d ago';
}

function renderClientList(clients, targetId) {
  const el = document.getElementById(targetId);
  if (!clients.length) {
    el.innerHTML = `<div class="empty-state"><div class="ei">üë•</div><div class="et">No clients yet</div><div class="es">Invite your first client to get started.</div></div>`;
    return;
  }
  el.innerHTML = clients.map(c => {
    const daysSince = c.last_logged ? (Date.now()-new Date(c.last_logged))/86400000 : 99;
    const compClass = daysSince < 1 ? 'comp-high' : daysSince < 3 ? 'comp-mid' : 'comp-low';
    const phase = c.phase || 'maintain';
    return `<div class="client-row" onclick="openClient('${c.id}')">
      <div class="compliance-dot ${compClass}"></div>
      <div class="c-av" style="background:${clientColor(c.name)}">${initials(c.name)}</div>
      <div style="flex:1">
        <div class="c-name">${c.name}</div>
        <div class="c-meta">${c.email} ¬∑ <span class="phase-chip phase-${phase}">${phase}</span></div>
      </div>
      <div class="c-stats">
        <div class="c-stat"><div class="c-stat-v">${c.meals_7d||0}</div><div class="c-stat-l">Meals/7d</div></div>
        <div class="c-stat"><div class="c-stat-v">${c.workouts_7d||0}</div><div class="c-stat-l">Sessions</div></div>
        <div class="c-stat"><div class="c-stat-v">${timeAgo(c.last_logged)}</div><div class="c-stat-l">Last logged</div></div>
      </div>
    </div>`;
  }).join('');
}

async function openClient(clientId) {
  S.currentClient = S.clients.find(c => c.id === clientId);
  if (!S.currentClient) return;
  nav('client-detail');
  document.getElementById('nav-clients').classList.add('active');
  document.getElementById('detail-name').textContent = S.currentClient.name;
  document.getElementById('detail-email').textContent = S.currentClient.email;
  document.getElementById('detail-av').textContent = initials(S.currentClient.name);
  document.getElementById('detail-av').style.background = clientColor(S.currentClient.name);
  document.getElementById('detail-phase').value = S.currentClient.phase || 'maintain';
  document.getElementById('detail-body').innerHTML = '<div style="text-align:center;padding:20px"><div class="loader"></div></div>';
  const r = await API('/clients/' + clientId);
  S.currentClientData = r;
  renderDetailTab('overview');
}

function detailTab(tab, el) {
  document.querySelectorAll('.detail-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderDetailTab(tab);
}

function renderDetailTab(tab) {
  const d = S.currentClientData;
  const el = document.getElementById('detail-body');
  if (!d || !d.success) { el.innerHTML = '<div class="empty-state"><div class="es">Failed to load client data.</div></div>'; return; }
  if (tab === 'overview') {
    const meals7 = d.meals?.length || 0;
    const workouts = d.workouts?.length || 0;
    const lastP = d.progress?.[0];
    const assignments = d.assignments || [];
    el.innerHTML = `
      <div class="metrics-row">
        <div class="metric"><div class="metric-label">Meals (30d)</div><div class="metric-value mv-green">${meals7}</div></div>
        <div class="metric"><div class="metric-label">Workouts</div><div class="metric-value mv-blue">${workouts}</div></div>
        <div class="metric"><div class="metric-label">Last Weight</div><div class="metric-value mv-amber">${lastP?.weight ? lastP.weight+'kg' : '‚Äî'}</div></div>
        <div class="metric"><div class="metric-label">Plans</div><div class="metric-value mv-purple">${assignments.length}</div></div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">Assigned Plans</span><button class="btn btn-green btn-sm" onclick="openAssignModal()">Assign Plan</button></div>
        <div class="card-body">
          ${assignments.length ? assignments.map(a => `
            <div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)">
              <span class="tag ${a.plan_type==='meal'?'tag-green':'tag-blue'}">${a.plan_type}</span>
              <span style="font-size:.82rem;font-weight:600">${a.meal_plan_name||a.workout_plan_name||'Plan #'+a.plan_id}</span>
              <span style="margin-left:auto;font-size:.72rem;color:var(--text3)">Assigned ${timeAgo(a.assigned_at)}</span>
            </div>`).join('') : '<div style="color:var(--text3);font-size:.78rem">No plans assigned yet.</div>'}
        </div>
      </div>`;
  } else if (tab === 'meals') {
    const meals = d.meals || [];
    el.innerHTML = meals.length ? meals.slice(0,20).map(m =>
      `<div class="food-item"><div class="food-name">${m.food_name||m.foodName}</div><div><div class="food-cals">${m.calories} cal</div><div class="food-macro">P:${m.protein||0}g C:${m.carbs||0}g F:${m.fat||0}g</div></div><div style="font-size:.72rem;color:var(--text3);margin-left:8px">${timeAgo(m.date)}</div></div>`
    ).join('') : '<div class="empty-state"><div class="es">No meal logs yet.</div></div>';
  } else if (tab === 'workouts') {
    const wk = d.workouts || [];
    el.innerHTML = wk.length ? wk.slice(0,20).map(w =>
      `<div class="workout-item"><span class="tag tag-blue">${w.workout_type||w.workoutType}</span><div class="exercise-name">${w.notes||'Session'}</div><div class="exercise-detail">${w.duration||0}min ¬∑ ${w.calories_burned||0} cal</div><div style="margin-left:auto;font-size:.72rem;color:var(--text3)">${timeAgo(w.date)}</div></div>`
    ).join('') : '<div class="empty-state"><div class="es">No workout logs yet.</div></div>';
  } else if (tab === 'progress') {
    const prog = d.progress || [];
    el.innerHTML = prog.length ? prog.slice(0,20).map(p =>
      `<div style="display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border)">
        <span style="font-size:.75rem;color:var(--text3);min-width:70px">${timeAgo(p.date)}</span>
        ${p.weight?`<span class="tag tag-green">${p.weight}kg</span>`:''}
        ${p.body_fat_percentage?`<span class="tag tag-amber">${p.body_fat_percentage}% BF</span>`:''}
        ${p.notes?`<span style="font-size:.75rem;color:var(--text2)">${p.notes}</span>`:''}
      </div>`
    ).join('') : '<div class="empty-state"><div class="es">No progress logs yet.</div></div>';
  }
}

async function updateClientPhase() {
  if (!S.currentClient) return;
  const phase = document.getElementById('detail-phase').value;
  await API('/clients/'+S.currentClient.id, { method:'PATCH', body: JSON.stringify({ phase }) });
  S.currentClient.phase = phase;
}

async function openAssignModal() {
  openModal('modal-assign');
  const sel = document.getElementById('assign-plan-select');
  const type = document.getElementById('assign-type').value;
  document.getElementById('assign-type').onchange = openAssignModal;
  const plans = type === 'meal' ? S.mealPlans : S.workoutPlans;
  if (!plans.length) await (type === 'meal' ? loadMealPlans() : loadWorkoutPlans());
  const list = type === 'meal' ? S.mealPlans : S.workoutPlans;
  sel.innerHTML = list.length ? list.map(p => `<option value="${p.id}">${p.name}</option>`).join('') : '<option>No plans yet ‚Äî create one first</option>';
}

async function doAssignPlan() {
  if (!S.currentClient) return;
  const planType = document.getElementById('assign-type').value;
  const planId = document.getElementById('assign-plan-select').value;
  if (!planId || isNaN(parseInt(planId))) { toast('Select a plan first', 'error'); return; }
  const r = await API('/clients/'+S.currentClient.id+'/assign-plan', { method:'POST', body: JSON.stringify({ planType, planId: parseInt(planId) }) });
  closeModal('modal-assign');
  if (r.success) { toast('Plan assigned ‚úì'); openClient(S.currentClient.id); }
  else toast('Failed to assign plan', 'error');
}

// ‚îÄ‚îÄ INVITE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function createInvite() {
  const email = document.getElementById('inv-email').value.trim();
  const r = await API('/clients/invite', { method:'POST', body: JSON.stringify({ email: email||undefined }) });
  closeModal('modal-invite');
  if (r.success) {
    S.inviteLink = r.inviteUrl;
    document.getElementById('invite-link-text').textContent = r.inviteUrl;
    document.getElementById('invite-banner').style.display = '';
    nav('clients');
    toast('Invite link ready ‚Äî copy and share it ‚úì');
  } else {
    toast('Could not generate invite link', 'error');
  }
}
function copyInvite() {
  navigator.clipboard.writeText(S.inviteLink||'');
  document.querySelector('.copy-btn').textContent = 'Copied!';
  setTimeout(() => document.querySelector('.copy-btn').textContent = 'Copy', 2000);
}

// ‚îÄ‚îÄ MEAL PLANS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadMealPlans() {
  const r = await API('/meal-plans');
  S.mealPlans = r.plans || [];
  const grid = document.getElementById('meal-plans-grid');
  if (!grid) return;
  if (!S.mealPlans.length) {
    grid.innerHTML = `<div style="grid-column:1/-1"><div class="empty-state"><div class="ei">ü•ó</div><div class="et">No meal plans yet</div><div class="es">Create your first plan and assign it to a client.</div></div></div>`;
    return;
  }
  grid.innerHTML = S.mealPlans.map(p => `
    <div class="plan-card">
      <div class="plan-card-name">${p.name}</div>
      <div class="plan-card-meta">${p.goal_type||'general'} ¬∑ ${p.total_calories||0} cal/day</div>
      ${p.description ? `<div style="font-size:.75rem;color:var(--text3);margin-top:4px">${p.description}</div>` : ''}
      <div class="plan-card-footer">
        <span class="tag tag-green">Meal</span>
        <button class="btn btn-ghost2 btn-sm" style="margin-left:auto" onclick="generateListFromPlan(${p.id})">üõí Shopping List</button>
        <button class="btn btn-red btn-sm" onclick="deleteMealPlan(${p.id}, event)">‚úï</button>
      </div>
    </div>`).join('');
}

async function saveMealPlan() {
  const name = document.getElementById('mp-name').value.trim();
  if (!name) { toast('Plan name is required', 'error'); return; }
  const r = await API('/meal-plans', { method:'POST', body: JSON.stringify({
    name, description: document.getElementById('mp-desc').value.trim(),
    goalType: document.getElementById('mp-goal').value,
    totalCalories: parseInt(document.getElementById('mp-cals').value)||0,
    meals: [],
  })});
  closeModal('modal-mealplan');
  if (r.success) { S.mealPlans.push(r.plan); loadMealPlans(); toast('Meal plan created ‚úì'); }
  else toast('Failed to create plan', 'error');
}

async function deleteMealPlan(id, e) {
  e.stopPropagation();
  await API('/meal-plans/'+id, { method:'DELETE' });
  S.mealPlans = S.mealPlans.filter(p=>p.id!==id);
  loadMealPlans();
}

// ‚îÄ‚îÄ WORKOUT PLANS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadWorkoutPlans() {
  const r = await API('/workout-plans');
  S.workoutPlans = r.plans || [];
  const grid = document.getElementById('workout-plans-grid');
  if (!grid) return;
  if (!S.workoutPlans.length) {
    grid.innerHTML = `<div style="grid-column:1/-1"><div class="empty-state"><div class="ei">üèãÔ∏è</div><div class="et">No workout plans yet</div><div class="es">Create a program and assign it to clients.</div></div></div>`;
    return;
  }
  grid.innerHTML = S.workoutPlans.map(p => `
    <div class="plan-card">
      <div class="plan-card-name">${p.name}</div>
      <div class="plan-card-meta">${p.level||'intermediate'} ¬∑ ${p.frequency||3} days/week</div>
      ${p.description ? `<div style="font-size:.75rem;color:var(--text3);margin-top:4px">${p.description}</div>` : ''}
      <div class="plan-card-footer">
        <span class="tag tag-blue">Workout</span>
        <button class="btn btn-red btn-sm" style="margin-left:auto" onclick="deleteWorkoutPlan(${p.id}, event)">‚úï</button>
      </div>
    </div>`).join('');
}

async function saveWorkoutPlan() {
  const name = document.getElementById('wp-name').value.trim();
  if (!name) { toast('Plan name is required', 'error'); return; }
  const r = await API('/workout-plans', { method:'POST', body: JSON.stringify({
    name, description: document.getElementById('wp-desc').value.trim(),
    level: document.getElementById('wp-level').value,
    frequency: parseInt(document.getElementById('wp-freq').value)||3,
    workouts: [],
  })});
  closeModal('modal-workoutplan');
  if (r.success) { S.workoutPlans.push(r.plan); loadWorkoutPlans(); toast('Workout plan created ‚úì'); }
  else toast('Failed to create plan', 'error');
}

async function deleteWorkoutPlan(id, e) {
  e.stopPropagation();
  await API('/workout-plans/'+id, { method:'DELETE' });
  S.workoutPlans = S.workoutPlans.filter(p=>p.id!==id);
  loadWorkoutPlans();
}

// ‚îÄ‚îÄ SHOPPING LISTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadShoppingLists() {
  const r = await API('/shopping-list');
  S.shoppingLists = r.lists || [];
  renderShoppingLists(S.shoppingLists, 'shopping-lists-body');
}

const CAT_ICONS = { meat:'ü•©', dairy:'üßÄ', grains:'üåæ', vegetables:'ü•¶', fruit:'üçé', pantry:'ü´ô', other:'üì¶' };
function renderShoppingList(list, targetId) {
  const el = document.getElementById(targetId);
  if (!el) return;
  const items = list.items || [];
  if (!items.length) { el.innerHTML = '<div class="empty-state"><div class="es">No items in this list.</div></div>'; return; }
  const grouped = {};
  items.forEach(item => {
    const cat = item.category || 'other';
    if (!grouped[cat]) grouped[cat] = [];
    grouped[cat].push(item);
  });
  el.innerHTML = Object.entries(grouped).map(([cat, catItems]) => `
    <div class="shop-category">
      <div class="shop-cat-label"><span class="shop-cat-icon">${CAT_ICONS[cat]||'üì¶'}</span>${cat.charAt(0).toUpperCase()+cat.slice(1)}</div>
      ${catItems.map((item, i) => `
        <div class="shop-item ${item.checked?'checked':''}" id="si-${list.id}-${i}">
          <div class="shop-cb ${item.checked?'checked':''}" onclick="toggleShopItem(${list.id},${i})">${item.checked?'‚úì':''}</div>
          <span class="shop-name">${item.name}</span>
          <span class="shop-qty">${item.qty||''} ${item.unit||''}</span>
        </div>`).join('')}
    </div>`).join('');
}

function renderShoppingLists(lists, targetId) {
  const el = document.getElementById(targetId);
  if (!el) return;
  if (!lists.length) {
    el.innerHTML = `<div class="empty-state"><div class="ei">üõí</div><div class="et">No shopping lists yet</div><div class="es">Generate one from a meal plan.</div></div>`;
    return;
  }
  el.innerHTML = lists.map(list => `
    <div class="card" style="margin-bottom:14px">
      <div class="card-header">
        <span class="card-title">${list.name}</span>
        <div style="display:flex;gap:6px;align-items:center">
          ${list.completed ? '<span class="tag tag-green">Completed</span>' : ''}
          <button class="btn btn-ghost2 btn-sm" onclick="deleteShoppingList(${list.id})">‚úï</button>
        </div>
      </div>
      <div class="card-body" id="sl-${list.id}"></div>
    </div>`).join('');
  lists.forEach(list => renderShoppingList(list, 'sl-'+list.id));
}

async function toggleShopItem(listId, itemIdx) {
  const list = S.shoppingLists.find(l=>l.id===listId) || (S.portalData?.shoppingLists||[]).find(l=>l.id===listId);
  if (!list) return;
  list.items[itemIdx].checked = !list.items[itemIdx].checked;
  renderShoppingList(list, 'sl-'+listId);
  await API('/shopping-list/'+listId, { method:'PATCH', body: JSON.stringify({ items: list.items }) });
}

async function deleteShoppingList(id) {
  await API('/shopping-list/'+id, { method:'DELETE' });
  S.shoppingLists = S.shoppingLists.filter(l=>l.id!==id);
  renderShoppingLists(S.shoppingLists, 'shopping-lists-body');
}

async function generateShoppingList() {
  const planId = document.getElementById('gen-plan-select').value;
  const name = document.getElementById('gen-list-name').value.trim();
  const r = await API('/shopping-list/generate', { method:'POST', body: JSON.stringify({ mealPlanId: parseInt(planId), name: name||undefined }) });
  closeModal('modal-generate-shopping');
  if (r.success) { S.shoppingLists.unshift(r.list); loadShoppingLists(); }
}

async function generateListFromPlan(planId) {
  const r = await API('/shopping-list/generate', { method:'POST', body: JSON.stringify({ mealPlanId: planId }) });
  if (r.success) { S.shoppingLists.unshift(r.list); nav('shopping-lists'); }
}

// Populate generate modal plan select
document.getElementById('modal-generate-shopping').addEventListener('click', async () => {
  if (!S.mealPlans.length) await loadMealPlans();
  const sel = document.getElementById('gen-plan-select');
  sel.innerHTML = S.mealPlans.length
    ? S.mealPlans.map(p=>`<option value="${p.id}">${p.name}</option>`).join('')
    : '<option>No plans ‚Äî create one first</option>';
});

// ‚îÄ‚îÄ FAVOURITES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadFavourites() {
  const r = await API('/favourites');
  S.favourites = r.favourites || [];
  const grid = document.getElementById(S.role==='client' ? 'client-favs-grid' : 'pt-favs-grid');
  if (!grid) return;
  if (!S.favourites.length) {
    grid.innerHTML = `<div style="grid-column:1/-1"><div class="empty-state"><div class="ei">‚ù§Ô∏è</div><div class="et">No favourites yet</div><div class="es">Tap the heart on meals and workouts to save them here.</div></div></div>`;
    return;
  }
  grid.innerHTML = S.favourites.map(f => `
    <div class="fav-card">
      <div class="fav-heart" onclick="removeFav('${f.item_type}','${f.item_id}')">‚ù§Ô∏è</div>
      <div class="fav-type">${f.item_type}</div>
      <div class="fav-name">${f.item_data?.name || f.item_id}</div>
    </div>`).join('');
}

function favFromBtn(btn) {
  const type = btn.dataset.favType, id = btn.dataset.favId, name = btn.dataset.favName;
  toggleFav(type, id, { name });
  btn.classList.toggle('active');
}

async function toggleFav(itemType, itemId, itemData) {
  const exists = S.favourites.find(f => f.item_type===itemType && f.item_id===String(itemId));
  if (exists) {
    await API('/favourites/'+itemType+'/'+itemId, { method:'DELETE' });
    S.favourites = S.favourites.filter(f=>!(f.item_type===itemType && f.item_id===String(itemId)));
  } else {
    const r = await API('/favourites', { method:'POST', body: JSON.stringify({ itemType, itemId: String(itemId), itemData }) });
    if (r.success && r.favourite) S.favourites.push(r.favourite);
  }
}
async function removeFav(type, id) {
  await API('/favourites/'+type+'/'+id, { method:'DELETE' });
  S.favourites = S.favourites.filter(f=>!(f.item_type===type && f.item_id===id));
  loadFavourites();
}

// ‚îÄ‚îÄ CLIENT PORTAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function setupClientPortal() {
  const hour = new Date().getHours();
  const greet = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
  document.getElementById('portal-greeting').textContent = greet + ', ' + S.user.name.split(' ')[0] + ' üí™';
  setupMobileNav('client');

  // Load user profile / goals
  try {
    const prof = await API('/user/profile/' + S.user.id);
    if (prof.success && prof.profile && prof.profile.targetCalories) {
      S.goals = { fitnessGoal: prof.profile.fitnessGoal, targetCalories: prof.profile.targetCalories, targetProtein: prof.profile.targetProtein };
      renderGoalTargets();
    }
  } catch(e) { /* ignore */ }

  const r = await API('/portal/me');
  if (r.success) {
    S.portalData = r;
    if (r.pt) {
      document.getElementById('portal-pt-name').textContent = 'Managed by ' + r.pt.name;
    } else {
      document.getElementById('portal-pt-name').textContent = 'Solo tracking ‚Äî no trainer yet';
      // Show goals modal if no goals set and no plan
      if (!S.goals && !r.mealPlan) {
        setTimeout(() => openModal('modal-goals'), 800);
      }
    }
    // Dashboard metrics
    const todayMeals = (r.recentMeals||[]).filter(m => new Date(m.date).toDateString()===new Date().toDateString());
    document.getElementById('pm-meals').textContent = todayMeals.length;
    document.getElementById('pm-cals').textContent = todayMeals.reduce((s,m)=>s+(m.calories||0),0);
    const weekWorkouts = (r.recentWorkouts||[]).filter(w => (Date.now()-new Date(w.date)) < 7*86400000);
    document.getElementById('pm-workouts').textContent = weekWorkouts.length;
    document.getElementById('pm-streak').textContent = calcStreak(r.recentMeals||[]);
    if (r.mealPlan) {
      document.getElementById('home-mealplan').innerHTML = `<div class="portal-plan-name">${r.mealPlan.meal_plan_name||'Meal Plan'}</div><div class="portal-plan-meta">${r.mealPlan.total_calories||0} cal/day target</div>`;
    }
    if (r.workoutPlan) {
      document.getElementById('home-workoutplan').innerHTML = `<div class="portal-plan-name">${r.workoutPlan.workout_plan_name||'Workout Plan'}</div>`;
    }
  }
}

function calcStreak(meals) {
  if (!meals.length) return 0;
  const days = new Set(meals.map(m => new Date(m.date).toDateString()));
  let streak = 0, d = new Date();
  while (days.has(d.toDateString())) { streak++; d.setDate(d.getDate()-1); }
  return streak;
}

function renderPortalPlan() {
  const el = document.getElementById('portal-plan-body');
  if (!S.portalData) { el.innerHTML = '<div style="padding:20px;text-align:center"><div class="loader"></div></div>'; return; }
  const { mealPlan, workoutPlan } = S.portalData;
  let html = '';
  if (mealPlan) {
    html += `<div class="portal-plan"><div class="portal-plan-title">ü•ó Meal Plan</div>
      <div class="portal-plan-name">${mealPlan.meal_plan_name||'Meal Plan'}</div>
      <div class="portal-plan-meta">${mealPlan.total_calories||0} calories/day target</div>
      <div style="margin-top:12px"><button class="btn btn-green btn-sm" onclick="nav('portal-shopping')">üõí View Shopping List</button></div>
    </div>`;
  } else html += '<div class="empty-state" style="background:#fff;border-radius:var(--radius);padding:24px"><div class="ei">ü•ó</div><div class="et">No meal plan assigned</div><div class="es">Your trainer will assign one soon.</div></div>';
  if (workoutPlan) {
    html += `<div class="portal-plan"><div class="portal-plan-title">üèãÔ∏è Workout Plan</div>
      <div class="portal-plan-name">${workoutPlan.workout_plan_name||'Workout Plan'}</div>
    </div>`;
  } else html += '<div class="empty-state" style="background:#fff;border-radius:var(--radius);padding:24px;margin-top:14px"><div class="ei">üèãÔ∏è</div><div class="et">No workout plan assigned</div><div class="es">Your trainer will assign one soon.</div></div>';
  el.innerHTML = html;
}

function renderPortalShopping() {
  const el = document.getElementById('portal-shopping-body');
  if (!S.portalData) { el.innerHTML = '<div style="text-align:center;padding:20px"><div class="loader"></div></div>'; return; }
  const lists = S.portalData.shoppingLists || [];
  renderShoppingLists(lists, 'portal-shopping-body');
  // Patch items toggle to work from portal data
}

// ‚îÄ‚îÄ MEAL LOGGING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initMealDate() {
  const el = document.getElementById('meals-date');
  el.value = S.mealsDate;
  updateMealDateLabel();
}
function updateMealDateLabel() {
  const d = new Date(S.mealsDate);
  const label = document.getElementById('meals-date-label');
  label.textContent = d.toLocaleDateString('en-AU', {weekday:'long',day:'numeric',month:'long'});
}
async function loadTodayMeals() {
  S.mealsDate = document.getElementById('meals-date')?.value || S.mealsDate;
  updateMealDateLabel();
  const r = await API('/meals/daily/' + S.user.id + '/' + S.mealsDate);
  const meals = r.meals || {};
  let totalCals = 0, totalProtein = 0, totalCarbs = 0, totalFat = 0;
  ['breakfast','lunch','dinner','snack'].forEach(type => {
    const el = document.getElementById('log-'+type);
    if (!el) return;
    const items = meals[type] || [];
    el.innerHTML = items.length ? items.map(item => {
      totalCals += item.calories||0;
      totalProtein += item.protein||0;
      totalCarbs += item.carbs||0;
      totalFat += item.fat||0;
      const isFav = S.favourites.some(f=>f.item_type==='food'&&f.item_id===item.foodName);
      return `<div class="food-item">
        <div class="food-name">${item.foodName||item.food_name}</div>
        <div><div class="food-cals">${item.calories} cal</div><div class="food-macro">P:${item.protein||0}g C:${item.carbs||0}g F:${item.fat||0}g</div></div>
        <button class="fav-btn ${isFav?'active':''}" onclick="toggleFav('food','${item.foodName}',{name:'${item.foodName}',calories:${item.calories||0}});this.classList.toggle('active')">‚ù§Ô∏è</button>
      </div>`;
    }).join('') : '<div style="color:var(--text3);font-size:.75rem;padding:6px 0">Nothing logged yet</div>';
  });
  document.getElementById('meals-total-cals').textContent = totalCals;
  document.getElementById('meals-protein').textContent = totalProtein.toFixed(0)+'g';
  document.getElementById('meals-carbs').textContent = totalCarbs.toFixed(0)+'g';
  document.getElementById('meals-fat').textContent = totalFat.toFixed(0)+'g';
}

async function logMealEntry() {
  const body = {
    userId: S.user.id,
    date: new Date(S.mealsDate).toISOString(),
    mealType: document.getElementById('lm-meal').value,
    foodName: document.getElementById('lm-food').value.trim(),
    calories: parseInt(document.getElementById('lm-cals').value)||0,
    protein: parseFloat(document.getElementById('lm-protein').value)||0,
    carbs: parseFloat(document.getElementById('lm-carbs').value)||0,
    fat: parseFloat(document.getElementById('lm-fat').value)||0,
    servingSize: document.getElementById('lm-serving').value.trim(),
  };
  if (!body.foodName) { toast('Enter a food name', 'error'); return; }
  const r = await API('/meals/log', { method:'POST', body: JSON.stringify(body) });
  closeModal('modal-log-meal');
  document.getElementById('lm-food').value='';
  document.getElementById('lm-cals').value='';
  document.getElementById('lm-protein').value='';
  document.getElementById('lm-carbs').value='';
  document.getElementById('lm-fat').value='';
  if (r.success) { toast('Meal logged ‚úì'); loadTodayMeals(); }
  else toast('Failed to log meal', 'error');
}

// ‚îÄ‚îÄ WORKOUT LOG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadWorkoutLog() {
  const r = await API('/workouts/history/' + S.user.id);
  const workouts = r.workouts || [];
  const el = document.getElementById('workout-log-body');
  if (!el) return;
  el.innerHTML = workouts.length ? workouts.slice(0,20).map(w => `
    <div class="workout-item">
      <span class="tag tag-blue">${w.workout_type||w.workoutType}</span>
      <div class="exercise-name">${w.notes||'Session'}</div>
      <div class="exercise-detail">${w.duration||0}min ¬∑ ${w.calories_burned||0} cal</div>
      <div style="margin-left:auto;font-size:.72rem;color:var(--text3)">${timeAgo(w.date)}</div>
      <button class="fav-btn" data-fav-type="workout" data-fav-id="${w.id}" data-fav-name="${(w.workout_type||'workout').replace(/['"<>&]/g,'')}" onclick="favFromBtn(this)">‚ù§Ô∏è</button>
    </div>`).join('') : '<div class="empty-state"><div class="ei">üèãÔ∏è</div><div class="et">No workouts logged yet</div></div>';
}

async function logWorkoutEntry() {
  const body = {
    userId: S.user.id,
    date: new Date().toISOString(),
    workoutType: document.getElementById('lw-type').value.trim(),
    duration: parseInt(document.getElementById('lw-duration').value)||0,
    caloriesBurned: parseInt(document.getElementById('lw-cals').value)||0,
    notes: document.getElementById('lw-notes').value.trim(),
    exercises: [],
  };
  if (!body.workoutType) { toast('Enter a workout type', 'error'); return; }
  const r = await API('/workouts/log', { method:'POST', body: JSON.stringify(body) });
  closeModal('modal-log-workout');
  if (r.success || r.id) { toast('Session logged ‚úì'); loadWorkoutLog(); }
  else toast('Failed to log session', 'error');
}

// ‚îÄ‚îÄ PROGRESS LOG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadProgressLog() {
  const r = await API('/progress/history/' + S.user.id);
  const prog = r.progressLogs || r.history || [];
  const el = document.getElementById('progress-log-body');
  if (!el) return;
  el.innerHTML = prog.length ? prog.slice(0,20).map(p => `
    <div style="display:flex;align-items:center;gap:12px;padding:12px 14px;border-bottom:1px solid var(--border)">
      <span style="font-size:.75rem;color:var(--text3);min-width:80px">${new Date(p.date).toLocaleDateString('en-AU',{day:'numeric',month:'short'})}</span>
      ${p.weight?`<span class="tag tag-green">${p.weight}kg</span>`:''}
      ${p.body_fat_percentage?`<span class="tag tag-amber">${p.body_fat_percentage}% BF</span>`:''}
      ${p.measurements?.waist?`<span class="tag tag-blue">Waist: ${p.measurements.waist}cm</span>`:''}
      ${p.notes?`<span style="font-size:.75rem;color:var(--text2);flex:1">${p.notes}</span>`:''}
    </div>`).join('') : '<div class="empty-state"><div class="ei">üìà</div><div class="et">No measurements yet</div><div class="es">Log your first measurement to start tracking progress.</div></div>';
}

async function logProgressEntry() {
  const body = {
    userId: S.user.id,
    date: new Date().toISOString(),
    weight: parseFloat(document.getElementById('lp-weight').value)||null,
    bodyFatPercentage: parseFloat(document.getElementById('lp-bf').value)||null,
    measurements: {
      waist: parseFloat(document.getElementById('lp-waist').value)||null,
      chest: parseFloat(document.getElementById('lp-chest').value)||null,
    },
    notes: document.getElementById('lp-notes').value.trim(),
  };
  const r = await API('/progress/log', { method:'POST', body: JSON.stringify(body) });
  closeModal('modal-log-progress');
  if (r.success || r.id) { toast('Measurement saved ‚úì'); loadProgressLog(); }
  else toast('Failed to save measurement', 'error');
}

// ‚îÄ‚îÄ RECEIPT SCANNER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let receiptBase64 = null, receiptMime = null;

function receiptFileSelected(e) {
  const file = e.target.files[0];
  if (!file) return;
  receiptMime = file.type;
  const reader = new FileReader();
  reader.onload = ev => {
    receiptBase64 = ev.target.result; // full data URL
    document.getElementById('receipt-img-preview').src = receiptBase64;
    document.getElementById('receipt-preview').style.display = '';
    document.getElementById('receipt-drop-zone').style.display = 'none';
  };
  reader.readAsDataURL(file);
}

function clearReceipt() {
  receiptBase64 = null; receiptMime = null;
  document.getElementById('receipt-file').value = '';
  document.getElementById('receipt-preview').style.display = 'none';
  document.getElementById('receipt-drop-zone').style.display = '';
  document.getElementById('scan-results').style.display = 'none';
  document.getElementById('scan-empty').style.display = '';
  document.getElementById('share-card').style.display = 'none';
}

async function scanReceipt() {
  if (!receiptBase64) return;
  document.getElementById('scan-loading').style.display = '';
  document.getElementById('scan-empty').style.display = 'none';
  document.getElementById('scan-results').style.display = 'none';
  document.getElementById('scan-btn').disabled = true;
  try {
    const r = await fetch('/api/receipt/scan', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + S.token },
      body: JSON.stringify({ image: receiptBase64, mimeType: receiptMime }),
    });
    const data = await r.json();
    if (!data.success) throw new Error(data.error || 'Scan failed');
    renderScanResults(data);
  } catch(err) {
    document.getElementById('scan-empty').style.display = '';
    document.getElementById('scan-empty').innerHTML = `<div style="font-size:28px">‚ö†Ô∏è</div><div style="font-size:.85rem;font-weight:600;color:var(--red);margin-top:8px">${err.message}</div>`;
  } finally {
    document.getElementById('scan-loading').style.display = 'none';
    document.getElementById('scan-btn').disabled = false;
  }
}

const CAT_EMOJI2 = {meat:'ü•©',dairy:'ü•õ',grains:'üåæ',vegetables:'ü•¶',fruit:'üçé',pantry:'ü´ô',beverage:'ü•§',supplement:'üíä',other:'üì¶'};

function renderScanResults(data) {
  const { weeklyTotals: t, grade: g, items, shareText: st, itemCount } = data;
  document.getElementById('scan-grade').textContent = g;
  document.getElementById('scan-protein').textContent = t.protein + 'g';
  document.getElementById('scan-cals').textContent = t.calories.toLocaleString();
  document.getElementById('scan-carbs').textContent = t.carbs + 'g';
  document.getElementById('scan-fat').textContent = t.fat + 'g';
  document.getElementById('scan-item-count').textContent = itemCount;
  document.getElementById('scan-items').textContent = itemCount;

  // Store scan data globally for logging
  S.lastScan = data;

  // Render items grouped with checkboxes for meal logging
  const grouped = data.byCategory || {};
  let html = '';
  let itemIdx = 0;
  for (const [cat, catItems] of Object.entries(grouped)) {
    html += `<div style="padding:8px 14px 2px;font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);background:var(--bg)">${CAT_EMOJI2[cat]||'üì¶'} ${cat}</div>`;
    catItems.forEach(item => {
      const idx = itemIdx++;
      html += `<label style="display:flex;align-items:center;gap:10px;padding:8px 14px;border-bottom:1px solid var(--border);cursor:pointer">
        <input type="checkbox" class="scan-item-cb" data-idx="${idx}" style="accent-color:var(--green2);width:16px;height:16px;flex-shrink:0" checked/>
        <span style="flex:1;font-size:.8rem;font-weight:500">${item.name}</span>
        <span style="font-size:.72rem;color:#3b82f6;font-weight:700">${item.nutrition.protein}g P</span>
        <span style="font-size:.72rem;color:var(--text3)">${item.nutrition.calories} cal</span>
      </label>`;
    });
  }
  document.getElementById('scan-items-list').innerHTML = html;

  // Add to meals CTA
  const allItems = Object.values(grouped).flat();
  const logBox = document.getElementById('scan-log-meals-box');
  if (logBox) {
    logBox.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 14px 0">
        <span style="font-size:.78rem;font-weight:700;color:var(--text)">üì• Log items to today's meals</span>
        <label style="font-size:.72rem;color:var(--green2);cursor:pointer"><input type="checkbox" id="cb-select-all" style="accent-color:var(--green2)" checked onchange="toggleAllScanItems(this.checked)"> Select all</label>
      </div>
      <div style="padding:8px 14px 14px">
        <div style="font-size:.72rem;color:var(--text3);margin-bottom:10px">Checked items will be added to your meal log for today.</div>
        <select id="scan-meal-type" style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:7px;font-size:.78rem;margin-bottom:10px;background:#fff">
          <option value="breakfast">Breakfast</option>
          <option value="lunch" selected>Lunch</option>
          <option value="dinner">Dinner</option>
          <option value="snack">Snack</option>
        </select>
        <button class="btn btn-green" style="width:100%" onclick="logScannedItems()">‚ûï Add to today's meals</button>
      </div>`;
    logBox.style.display = '';
  }

  document.getElementById('scan-results').style.display = '';

  // Share card
  document.getElementById('share-text-box').value = st;
  document.getElementById('share-card').style.display = '';
}

function toggleAllScanItems(checked) {
  document.querySelectorAll('.scan-item-cb').forEach(cb => cb.checked = checked);
}

async function logScannedItems() {
  if (!S.lastScan) return;
  const allItems = Object.values(S.lastScan.byCategory || {}).flat();
  const checked = [...document.querySelectorAll('.scan-item-cb:checked')].map(cb => allItems[parseInt(cb.dataset.idx)]).filter(Boolean);
  if (!checked.length) { toast('Select at least one item', 'warn'); return; }
  const mealType = document.getElementById('scan-meal-type').value;
  let logged = 0;
  for (const item of checked) {
    const body = {
      userId: S.user.id,
      date: new Date().toISOString(),
      mealType,
      foodName: item.name,
      calories: item.nutrition.calories || 0,
      protein: item.nutrition.protein || 0,
      carbs: item.nutrition.carbs || 0,
      fat: item.nutrition.fat || 0,
      servingSize: item.qty || '',
    };
    const r = await API('/meals/log', { method:'POST', body: JSON.stringify(body) });
    if (r.success) logged++;
  }
  if (logged) {
    toast(`‚úÖ ${logged} item${logged!==1?'s':''} logged to ${mealType}!`);
    document.querySelectorAll('.scan-item-cb').forEach(cb => cb.checked = false);
    document.getElementById('cb-select-all').checked = false;
  } else {
    toast('Could not log items ‚Äî try again', 'error');
  }
}

function copyShareText() {
  const txt = document.getElementById('share-text-box').value;
  navigator.clipboard.writeText(txt).then(() => {
    const btn = document.querySelector('#share-card .btn-green');
    const orig = btn.textContent;
    btn.textContent = '‚úì Copied!';
    setTimeout(() => btn.textContent = orig, 2000);
  });
}

// ‚îÄ‚îÄ GOALS ONBOARDING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveGoals() {
  const fitnessGoal  = document.getElementById('goal-type').value;
  const targetCalories = parseInt(document.getElementById('goal-calories').value) || 0;
  const targetProtein  = parseInt(document.getElementById('goal-protein').value) || 0;
  const weight   = parseFloat(document.getElementById('goal-weight').value) || null;
  if (!targetCalories || !targetProtein) { toast('Enter calorie and protein targets', 'warn'); return; }
  await API('/user/profile', { method:'POST', body: JSON.stringify({ fitnessGoal, targetCalories, targetProtein }) });
  if (weight) await API('/progress/log', { method:'POST', body: JSON.stringify({ userId: S.user.id, date: new Date().toISOString(), weight }) });
  S.goals = { fitnessGoal, targetCalories, targetProtein };
  closeModal('modal-goals');
  toast('Goals saved! Let\'s go üî•');
  renderGoalTargets();
}

function renderGoalTargets() {
  const g = S.goals;
  if (!g) return;
  const el = document.getElementById('portal-goal-banner');
  if (!el) return;
  el.innerHTML = `<div style="display:flex;gap:12px;flex-wrap:wrap">
    <div style="flex:1;min-width:120px;background:#fff;border:1px solid var(--border);border-radius:10px;padding:12px 14px;text-align:center">
      <div style="font-size:.65rem;color:var(--text3);font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Daily Calories</div>
      <div style="font-size:1.3rem;font-weight:900;color:var(--green2)">${(g.targetCalories||0).toLocaleString()}</div>
      <div style="font-size:.65rem;color:var(--text3)">target</div>
    </div>
    <div style="flex:1;min-width:120px;background:#fff;border:1px solid var(--border);border-radius:10px;padding:12px 14px;text-align:center">
      <div style="font-size:.65rem;color:var(--text3);font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Protein Goal</div>
      <div style="font-size:1.3rem;font-weight:900;color:#3b82f6">${g.targetProtein||0}g</div>
      <div style="font-size:.65rem;color:var(--text3)">per day</div>
    </div>
    <div style="flex:1;min-width:120px;background:#fff;border:1px solid var(--border);border-radius:10px;padding:12px 14px;text-align:center">
      <div style="font-size:.65rem;color:var(--text3);font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Goal</div>
      <div style="font-size:.88rem;font-weight:800;color:var(--text)">${({lose_weight:'üî• Cut',muscle_gain:'üí™ Bulk',maintain:'‚öñÔ∏è Maintain',general_fitness:'üèÉ Fitness'})[g.fitnessGoal]||'‚Äî'}</div>
      <button class="btn btn-ghost2 btn-sm" style="margin-top:6px;font-size:.65rem" onclick="openModal('modal-goals')">Edit</button>
    </div>
  </div>`;
  el.style.display = '';
}

// ‚îÄ‚îÄ SCAN CARD DOWNLOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function downloadScanCard() {
  if (!S.lastScan) { toast('Scan a receipt first', 'warn'); return; }
  const { weeklyTotals: t, grade: g } = S.lastScan;
  const canvas = document.createElement('canvas');
  canvas.width = 1080; canvas.height = 1080;
  const ctx = canvas.getContext('2d');

  // Background gradient
  const grad = ctx.createLinearGradient(0, 0, 1080, 1080);
  grad.addColorStop(0, '#0a1a0a'); grad.addColorStop(1, '#0d2d1a');
  ctx.fillStyle = grad; ctx.fillRect(0, 0, 1080, 1080);

  // Brand
  ctx.fillStyle = '#22c55e'; ctx.font = 'bold 36px system-ui,sans-serif';
  ctx.fillText('FitMunch', 80, 100);
  ctx.fillStyle = '#86efac'; ctx.font = '24px system-ui,sans-serif';
  ctx.fillText('Weekly Shop Scan', 80, 140);

  // Grade
  ctx.fillStyle = '#22c55e'; ctx.font = 'bold 240px system-ui,sans-serif';
  ctx.textAlign = 'right'; ctx.fillText(g, 1000, 380);
  ctx.textAlign = 'left';
  ctx.fillStyle = '#86efac'; ctx.font = '28px system-ui,sans-serif';
  ctx.fillText('Nutrition Grade', 80, 380);

  // Divider
  ctx.strokeStyle = 'rgba(134,239,172,0.3)'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(80, 430); ctx.lineTo(1000, 430); ctx.stroke();

  // Stats
  const stats = [
    ['ü•©', 'Protein', t.protein + 'g', '#22c55e'],
    ['üî•', 'Calories', t.calories.toLocaleString(), '#f59e0b'],
    ['üåæ', 'Carbs', t.carbs + 'g', '#3b82f6'],
    ['üßà', 'Fat', t.fat + 'g', '#a78bfa'],
  ];
  stats.forEach(([emoji, label, value, color], i) => {
    const x = 80 + i * 240;
    ctx.fillStyle = color; ctx.font = 'bold 72px system-ui,sans-serif';
    ctx.fillText(value, x, 580);
    ctx.fillStyle = '#86efac'; ctx.font = '28px system-ui,sans-serif';
    ctx.fillText(emoji + ' ' + label, x, 630);
  });

  // Hashtags
  ctx.fillStyle = 'rgba(134,239,172,0.6)'; ctx.font = '26px system-ui,sans-serif';
  ctx.fillText('#FitMunch  #RateMyWeeklyShop  #MacroTracking  #FitnessAustralia', 80, 900);

  // fitmunch.com.au
  ctx.fillStyle = '#22c55e'; ctx.font = 'bold 28px system-ui,sans-serif';
  ctx.fillText('fitmunch.com.au', 80, 970);

  const link = document.createElement('a');
  link.download = 'fitmunch-scan-' + g + '.png';
  link.href = canvas.toDataURL('image/png');
  link.click();
  toast('Card downloaded! Post it to TikTok or IG üî•');
}

// ‚îÄ‚îÄ CHECKOUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function startCheckout(plan) {
  try {
    const r = await API('/checkout', { method:'POST', body: JSON.stringify({ plan }) });
    if (r.url) window.location.href = r.url;
    else toast('Checkout unavailable ‚Äî ' + (r.error || 'please try again'), 'error');
  } catch { toast('Could not start checkout. Try again.', 'error'); }
}

// ‚îÄ‚îÄ TOAST NOTIFICATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toast(msg, type='success') {
  const t = document.createElement('div');
  t.style.cssText = `position:fixed;bottom:24px;right:24px;z-index:9999;padding:12px 18px;border-radius:9px;font-size:.82rem;font-weight:600;color:#fff;background:${type==='error'?'#ef4444':type==='warn'?'#f59e0b':'#16a34a'};box-shadow:0 4px 20px rgba(0,0,0,.2);animation:slideIn .2s ease;max-width:320px;line-height:1.4`;
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => { t.style.opacity='0'; t.style.transition='opacity .3s'; setTimeout(()=>t.remove(),300); }, 3000);
}

function shareNative() {
  const txt = document.getElementById('share-text-box').value;
  if (navigator.share) {
    navigator.share({ text: txt, title: 'My FitMunch Weekly Shop' }).catch(() => {});
  } else {
    navigator.clipboard.writeText(txt);
    alert('Caption copied to clipboard ‚Äî paste it into TikTok or Instagram.');
  }
}

// Drag and drop on receipt zone
document.addEventListener('DOMContentLoaded', () => {
  const dz = document.getElementById('receipt-drop-zone');
  if (!dz) return;
  dz.addEventListener('dragover', e => { e.preventDefault(); dz.style.borderColor='var(--green2)'; });
  dz.addEventListener('dragleave', () => dz.style.borderColor='#bbf7d0');
  dz.addEventListener('drop', e => {
    e.preventDefault(); dz.style.borderColor='#bbf7d0';
    const file = e.dataTransfer.files[0];
    if (file) { const fakeEv={target:{files:[file]}}; receiptFileSelected(fakeEv); }
  });
});

// ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
boot();
</script>
</body>
</html>
