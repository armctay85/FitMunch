<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FitMunch — Sign In</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --green:  #22c55e;
      --green2: #16a34a;
      --bg:     #060c06;
      --card:   #0d150d;
      --border: #1a2e1a;
      --muted:  #4b5e4b;
      --text:   #e8f5e8;
      --sub:    #8fa98f;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg); color: var(--text);
      min-height: 100vh; display: flex; align-items: center; justify-content: center;
      padding: 20px;
    }

    .card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 20px; padding: 40px 36px; width: 100%; max-width: 420px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.6);
    }

    .logo {
      display: flex; align-items: center; gap: 10px; margin-bottom: 28px; justify-content: center;
    }
    .logo img { width: 40px; height: 40px; border-radius: 10px; }
    .logo-text { font-size: 1.5rem; font-weight: 800; color: var(--text); }
    .logo-text span { color: var(--green); }

    .tabs {
      display: flex; background: #0f160f; border-radius: 10px;
      padding: 4px; margin-bottom: 28px; border: 1px solid var(--border);
    }
    .tab {
      flex: 1; text-align: center; padding: 9px; border-radius: 7px;
      font-size: 0.88rem; font-weight: 600; cursor: pointer;
      color: var(--muted); transition: all 0.2s;
    }
    .tab.active {
      background: var(--green2); color: white;
      box-shadow: 0 2px 8px rgba(34,197,94,0.3);
    }

    .form-group { margin-bottom: 16px; }
    label {
      display: block; font-size: 0.76rem; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.5px;
      color: var(--sub); margin-bottom: 7px;
    }
    input {
      width: 100%; background: #0f160f; border: 1px solid var(--border);
      color: var(--text); padding: 12px 14px; border-radius: 10px;
      font-size: 0.92rem; font-family: inherit; outline: none;
      transition: border-color 0.2s;
    }
    input:focus { border-color: var(--green); }
    input::placeholder { color: var(--muted); }

    .btn {
      width: 100%; background: var(--green2); color: white;
      border: none; padding: 13px; border-radius: 10px;
      font-size: 0.95rem; font-weight: 700; cursor: pointer;
      transition: background 0.2s, transform 0.1s; margin-top: 6px;
      letter-spacing: 0.3px;
    }
    .btn:hover  { background: #15803d; }
    .btn:active { transform: scale(0.98); }
    .btn:disabled { background: var(--muted); cursor: not-allowed; }

    .error-msg {
      background: #2d0f0f; border: 1px solid #7f1d1d; color: #f87171;
      padding: 10px 14px; border-radius: 8px; font-size: 0.82rem;
      margin-bottom: 16px; display: none;
    }
    .error-msg.show { display: block; }

    .success-msg {
      background: #0d2d1a; border: 1px solid #166534; color: #4ade80;
      padding: 10px 14px; border-radius: 8px; font-size: 0.82rem;
      margin-bottom: 16px; display: none;
    }
    .success-msg.show { display: block; }

    .divider { border: none; border-top: 1px solid var(--border); margin: 20px 0; }

    .foot {
      text-align: center; font-size: 0.78rem; color: var(--muted); margin-top: 20px;
    }
    .foot a { color: var(--green); text-decoration: none; }
    .foot a:hover { text-decoration: underline; }

    .spinner {
      display: inline-block; width: 16px; height: 16px;
      border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff;
      border-radius: 50%; animation: spin 0.7s linear infinite;
      vertical-align: middle; margin-right: 6px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .panel { display: none; }
    .panel.active { display: block; }

    .strength-bar { height: 3px; background: var(--border); border-radius: 2px; margin-top: 6px; overflow: hidden; }
    .strength-fill { height: 100%; border-radius: 2px; transition: width 0.3s, background 0.3s; width: 0%; }
    .strength-label { font-size: 0.65rem; color: var(--muted); margin-top: 3px; }
  </style>
</head>
<body>

<div class="card">
  <div class="logo">
    <svg width="44" height="44" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" style="flex-shrink:0">
      <defs>
        <linearGradient id="lb" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stop-color="#14532d"/><stop offset="100%" stop-color="#052e16"/>
        </linearGradient>
        <linearGradient id="lbr" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" stop-color="#4ade80"/><stop offset="100%" stop-color="#22c55e"/>
        </linearGradient>
        <linearGradient id="la" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" stop-color="#4ade80"/><stop offset="100%" stop-color="#16a34a"/>
        </linearGradient>
      </defs>
      <rect width="512" height="512" rx="115" fill="url(#lb)"/>
      <!-- Broccoli -->
      <circle cx="256" cy="128" r="82" fill="url(#lbr)"/>
      <circle cx="175" cy="168" r="68" fill="url(#lbr)"/>
      <circle cx="337" cy="168" r="68" fill="url(#lbr)"/>
      <ellipse cx="256" cy="200" rx="110" ry="52" fill="url(#lbr)"/>
      <circle cx="232" cy="108" r="22" fill="#16a34a" opacity="0.5"/>
      <circle cx="278" cy="100" r="18" fill="#16a34a" opacity="0.5"/>
      <circle cx="162" cy="150" r="18" fill="#16a34a" opacity="0.45"/>
      <circle cx="322" cy="148" r="18" fill="#16a34a" opacity="0.45"/>
      <!-- Stalk -->
      <rect x="228" y="228" width="56" height="108" rx="12" fill="white"/>
      <!-- Dumbbell bar -->
      <rect x="142" y="348" width="228" height="26" rx="13" fill="white"/>
      <!-- Collars -->
      <rect x="166" y="334" width="34" height="54" rx="9" fill="url(#la)"/>
      <rect x="312" y="334" width="34" height="54" rx="9" fill="url(#la)"/>
      <!-- Plates -->
      <rect x="118" y="316" width="62" height="90" rx="16" fill="white"/>
      <rect x="134" y="334" width="26" height="54" rx="8" fill="url(#lb)"/>
      <rect x="332" y="316" width="62" height="90" rx="16" fill="white"/>
      <rect x="352" y="334" width="26" height="54" rx="8" fill="url(#lb)"/>
    </svg>
    <div class="logo-text">Fit<span>Munch</span></div>
  </div>

  <div class="tabs">
    <div class="tab active" id="tab-login"    onclick="showTab('login')">Sign In</div>
    <div class="tab"        id="tab-register" onclick="showTab('register')">Create Account</div>
  </div>

  <!-- LOGIN PANEL -->
  <div class="panel active" id="panel-login">
    <div class="error-msg"   id="login-error"></div>
    <div class="success-msg" id="login-success"></div>

    <div class="form-group">
      <label for="login-email">Email</label>
      <input type="email" id="login-email" placeholder="you@example.com" autocomplete="email" />
    </div>
    <div class="form-group">
      <label for="login-password">Password</label>
      <input type="password" id="login-password" placeholder="Your password" autocomplete="current-password" />
    </div>

    <button class="btn" id="login-btn" onclick="doLogin()">Sign In</button>

    <div class="foot">
      Don't have an account? <a href="#" onclick="showTab('register'); return false;">Create one free</a>
    </div>
  </div>

  <!-- REGISTER PANEL -->
  <div class="panel" id="panel-register">
    <div class="error-msg"   id="register-error"></div>
    <div class="success-msg" id="register-success"></div>

    <div class="form-group">
      <label for="reg-name">Your Name</label>
      <input type="text" id="reg-name" placeholder="Alex Smith" autocomplete="name" />
    </div>
    <div class="form-group">
      <label for="reg-email">Email</label>
      <input type="email" id="reg-email" placeholder="you@example.com" autocomplete="email" />
    </div>
    <div class="form-group">
      <label for="reg-password">Password</label>
      <input type="password" id="reg-password" placeholder="Min. 8 characters" autocomplete="new-password"
             oninput="checkStrength(this.value)" />
      <div class="strength-bar"><div class="strength-fill" id="strength-fill"></div></div>
      <div class="strength-label" id="strength-label"></div>
    </div>

    <button class="btn" id="register-btn" onclick="doRegister()">Create Free Account</button>

    <div class="foot">
      Already have an account? <a href="#" onclick="showTab('login'); return false;">Sign in</a>
    </div>
  </div>
</div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const plan = urlParams.get('plan') || null; // 'starter' | 'pro' | null

  // Redirect if already logged in
  const existingToken = localStorage.getItem('fm_token');
  if (existingToken) {
    fetch('/api/auth/me', { headers: { Authorization: 'Bearer ' + existingToken } })
      .then(r => r.json())
      .then(d => { if (d.success) redirectAfterAuth(existingToken); })
      .catch(() => {});
  }

  async function redirectAfterAuth(token) {
    if (plan) {
      // Go straight to Stripe checkout with trial
      try {
        const r = await fetch('/api/checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({ plan })
        });
        const d = await r.json();
        if (d.url) { window.location.href = d.url; return; }
      } catch {}
    }
    window.location.href = '/app.html';
  }

  function showTab(tab) {
    ['login','register'].forEach(t => {
      document.getElementById('tab-' + t).classList.toggle('active', t === tab);
      document.getElementById('panel-' + t).classList.toggle('active', t === tab);
    });
  }

  function setLoading(btnId, loading) {
    const btn = document.getElementById(btnId);
    btn.disabled = loading;
    btn.innerHTML = loading
      ? '<span class="spinner"></span>Please wait...'
      : (btnId === 'login-btn' ? 'Sign In' : 'Create Free Account');
  }

  function showError(id, msg)   { const el = document.getElementById(id); el.textContent = msg; el.classList.add('show'); }
  function hideMsg(prefix)      { ['-error','-success'].forEach(s => { const el = document.getElementById(prefix+s); el.classList.remove('show'); }); }
  function showSuccess(id, msg) { const el = document.getElementById(id); el.textContent = msg; el.classList.add('show'); }

  function checkStrength(pw) {
    const fill  = document.getElementById('strength-fill');
    const label = document.getElementById('strength-label');
    let score = 0;
    if (pw.length >= 8)  score++;
    if (pw.length >= 12) score++;
    if (/[A-Z]/.test(pw)) score++;
    if (/[0-9]/.test(pw)) score++;
    if (/[^a-zA-Z0-9]/.test(pw)) score++;
    const levels = [
      { pct: '20%', bg: '#ef4444', text: 'Very weak' },
      { pct: '40%', bg: '#f97316', text: 'Weak' },
      { pct: '60%', bg: '#eab308', text: 'Fair' },
      { pct: '80%', bg: '#22c55e', text: 'Good' },
      { pct: '100%', bg: '#16a34a', text: 'Strong ✓' },
    ];
    const l = levels[Math.max(0, score - 1)] || { pct: '0%', bg: '#2d3148', text: '' };
    fill.style.width = l.pct; fill.style.background = l.bg; label.textContent = l.text;
  }

  async function doLogin() {
    hideMsg('login');
    const email    = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value;
    if (!email || !password) { showError('login-error', 'Please enter your email and password.'); return; }
    setLoading('login-btn', true);
    try {
      const r    = await fetch('/api/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) });
      const data = await r.json();
      if (!data.success) { showError('login-error', data.error); return; }
      localStorage.setItem('fm_token', data.token);
      localStorage.setItem('fm_user',  JSON.stringify(data.user));
      showSuccess('login-success', plan ? 'Logged in! Setting up your trial...' : 'Logged in! Redirecting...');
      setTimeout(() => redirectAfterAuth(data.token), 600);
    } catch { showError('login-error', 'Network error. Please try again.'); }
    finally   { setLoading('login-btn', false); }
  }

  async function doRegister() {
    hideMsg('register');
    const name     = document.getElementById('reg-name').value.trim();
    const email    = document.getElementById('reg-email').value.trim();
    const password = document.getElementById('reg-password').value;
    if (!name || !email || !password) { showError('register-error', 'All fields are required.'); return; }
    if (password.length < 8) { showError('register-error', 'Password must be at least 8 characters.'); return; }
    setLoading('register-btn', true);
    try {
      const inviteToken = new URLSearchParams(window.location.search).get('invite');
      const r    = await fetch('/api/auth/register', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, email, password, ...(inviteToken ? { inviteToken } : {}) }) });
      const data = await r.json();
      if (!data.success) { showError('register-error', data.error); return; }
      localStorage.setItem('fm_token', data.token);
      localStorage.setItem('fm_user',  JSON.stringify(data.user));
      showSuccess('register-success', plan ? 'Account created! Starting your 14-day trial...' : 'Account created! Redirecting...');
      setTimeout(() => redirectAfterAuth(data.token), 600);
    } catch { showError('register-error', 'Network error. Please try again.'); }
    finally   { setLoading('register-btn', false); }
  }

  // Enter key support
  document.addEventListener('keydown', e => {
    if (e.key !== 'Enter') return;
    if (document.getElementById('panel-login').classList.contains('active'))    doLogin();
    else if (document.getElementById('panel-register').classList.contains('active')) doRegister();
  });
</script>
</body>
</html>
